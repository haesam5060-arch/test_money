<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ì£¼ì‹ ë§¤ë§¤ ì‹œë®¬ë ˆì´í„° â€” ë²¤í¬ë“œ ë²•ì¹™ + ê¸°ìˆ ì  ë¶„ì„</title>
<script src="https://unpkg.com/lightweight-charts@4/dist/lightweight-charts.standalone.production.js"></script>
<style>
* { margin:0; padding:0; box-sizing:border-box; }
body { background:#0f0f1a; color:#d1d4dc; font-family:'Pretendard','Apple SD Gothic Neo',sans-serif; line-height:1.6; }
a { color:#5b9bd5; }

.container { max-width:1400px; margin:0 auto; padding:20px; }

/* Header */
header { text-align:center; padding:30px 0 20px; border-bottom:1px solid #2a2a3e; margin-bottom:30px; }

/* Global optimizing toast â€” overlays upload area */
#uploadAreaWrap { position:relative; }
#globalOptToast { display:none; position:absolute; inset:0; z-index:10; background:rgba(16,16,30,0.88); border-radius:12px; flex-direction:column; align-items:center; justify-content:center; gap:10px; pointer-events:none; }
#globalOptToast.active { display:flex; }
#globalOptToast .toast-text { font-size:20px; font-weight:700; color:#f5c842; letter-spacing:0.5px; }
@keyframes toast-pulse { 0%,100%{opacity:1;} 50%{opacity:0.2;} }
#globalOptToast .toast-text { animation:toast-pulse 0.9s ease-in-out infinite; }
#globalOptToast .toast-sub { font-size:13px; color:#aaa; }
header h1 { font-size:28px; color:#e0e0e0; margin-bottom:6px; }
header p { color:#888; font-size:14px; }

/* Cards */
.card { background:#1a1a2e; border:1px solid #2a2a3e; border-radius:12px; padding:24px; margin-bottom:20px; }
.card h2 { font-size:18px; color:#fff; margin-bottom:16px; padding-bottom:10px; border-bottom:1px solid #2a2a3e; }
.card h3 { font-size:15px; color:#aaa; margin:16px 0 8px; }

/* Upload Area */
.upload-area { border:2px dashed #3a3a5e; border-radius:12px; padding:28px; text-align:center; cursor:pointer; transition:all .2s; }
.upload-area:hover, .upload-area.dragover { border-color:#5b9bd5; background:#1e1e35; }
.upload-area .icon { font-size:34px; margin-bottom:8px; }
.upload-area p { color:#888; }
.upload-area .filename { color:#5b9bd5; font-weight:600; margin-top:8px; }
#fileInput { display:none; }

/* Instructions */
.instructions { background:#16162a; border:1px solid #252540; border-radius:8px; margin-top:16px; font-size:13px; color:#999; overflow:hidden; }
.instructions-toggle { display:flex; align-items:center; justify-content:space-between; padding:10px 16px; cursor:pointer; user-select:none; color:#888; font-size:13px; }
.instructions-toggle:hover { background:#1e1e38; }
.instructions-toggle .toggle-arrow { font-size:10px; transition:transform 0.25s; color:#555; }
.instructions-toggle.open .toggle-arrow { transform:rotate(180deg); }
.instructions-body { padding:0 20px 16px; display:none; }
.instructions-body.open { display:block; }
.instructions code { background:#252540; padding:2px 8px; border-radius:4px; color:#7ec8e3; font-size:12px; word-break:break-all; }
.instructions ol { padding-left:20px; }
.instructions li { margin:8px 0; }
.instructions table { width:100%; margin:10px 0; border-collapse:collapse; }
.instructions td, .instructions th { padding:4px 10px; border:1px solid #333; font-size:12px; }
.instructions th { background:#252540; color:#aaa; }

/* Parameters */
.params { display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:12px; margin-bottom:16px; }
.param-group label { display:block; font-size:12px; color:#888; margin-bottom:4px; }
.param-group input, .param-group select { width:100%; background:#252540; border:1px solid #3a3a5e; color:#fff; padding:8px 12px; border-radius:6px; font-size:14px; }
.param-group input:focus, .param-group select:focus { outline:none; border-color:#5b9bd5; }
.param-group select { appearance:none; background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23888' d='M6 8L1 3h10z'/%3E%3C/svg%3E"); background-repeat:no-repeat; background-position:right 12px center; cursor:pointer; }

/* Tooltip */
.tooltip-wrap { position:relative; display:inline-block; margin-left:4px; vertical-align:middle; }
.tooltip-icon { display:inline-flex; align-items:center; justify-content:center; width:16px; height:16px; background:#3a3a5e; color:#aaa; border-radius:50%; font-size:11px; font-weight:700; cursor:help; transition:all .2s; }
.tooltip-icon:hover { background:#5b9bd5; color:#fff; }
.tooltip-content { display:none; position:absolute; bottom:calc(100% + 8px); left:50%; transform:translateX(-50%); width:320px; background:#252540; border:1px solid #3a3a5e; border-radius:8px; padding:12px 14px; font-size:12px; color:#ccc; line-height:1.5; z-index:1000; box-shadow:0 4px 20px rgba(0,0,0,.5); text-align:left; white-space:normal; }
.tooltip-content::after { content:''; position:absolute; top:100%; left:50%; transform:translateX(-50%); border:6px solid transparent; border-top-color:#3a3a5e; }
.tooltip-wrap:hover .tooltip-content { display:block; }
.tooltip-content .tip-title { color:#5b9bd5; font-weight:600; margin-bottom:4px; }
.tooltip-content .tip-example { background:#1a1a2e; padding:6px 8px; border-radius:4px; margin-top:6px; color:#7ec8e3; font-size:11px; }
.tooltip-content .tip-recommend { color:#f5c842; font-size:11px; margin-top:6px; }

/* Buttons */
.btn { padding:12px 32px; border:none; border-radius:8px; font-size:16px; font-weight:600; cursor:pointer; transition:all .2s; }
.btn-primary { background:linear-gradient(135deg,#5b9bd5,#3a7bd5); color:#fff; }
.btn-primary:hover { transform:translateY(-1px); box-shadow:0 4px 15px rgba(59,123,213,.4); }
.btn-primary:disabled { opacity:.4; cursor:not-allowed; transform:none; box-shadow:none; }
.btn-sm { padding:6px 16px; font-size:13px; border-radius:6px; }
.btn-outline { background:transparent; border:1px solid #3a3a5e; color:#aaa; }
.btn-outline:hover { border-color:#5b9bd5; color:#5b9bd5; }
.btn-outline.active { border-color:#5b9bd5; color:#5b9bd5; background:rgba(91,155,213,.1); }

/* Stats Grid */
.stats-grid { display:grid; grid-template-columns:repeat(6,1fr); gap:12px; }
.stat-box { background:#16162a; border:1px solid #252540; border-radius:8px; padding:16px; text-align:center; }
.stat-box .value { font-size:24px; font-weight:700; margin:4px 0; }
.stat-box .label { font-size:11px; color:#888; text-transform:uppercase; }
.stat-box.highlight { border-color:#5b9bd5; background:#1a1a35; }
.stat-box.highlight .value { color:#5b9bd5; }
.win { color:#ef5350; }
.loss { color:#26a69a; }
.text-green { color:#4caf50; }
.text-red { color:#ef5350; }

/* Chart */
#chartContainer { width:100%; height:480px; border-radius:8px; overflow:hidden; }
#volumeContainer { width:100%; height:120px; border-radius:0 0 8px 8px; overflow:hidden; margin-top:-1px; }
.chart-legend { display:flex; gap:16px; padding:8px 0; font-size:12px; color:#888; flex-wrap:wrap; }
.chart-legend span { display:flex; align-items:center; gap:4px; }
.chart-legend .dot { width:10px; height:10px; border-radius:50%; display:inline-block; }
.chart-controls { display:flex; gap:8px; margin-top:12px; flex-wrap:wrap; }

/* Trade Table */
.trade-table { width:100%; border-collapse:collapse; font-size:13px; table-layout:fixed; }
.trade-table th { background:#252540; padding:10px 8px; text-align:left; color:#aaa; font-weight:500; position:sticky; top:0; z-index:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.trade-table td { padding:8px; border-bottom:1px solid #252540; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; vertical-align:middle; }
.trade-table td.reason-cell { text-align:center; overflow:visible; padding:6px 4px; }
.trade-table th.spacer-th { background:transparent; border:none; pointer-events:none; }
.trade-table td.spacer-td { border-bottom:1px solid #252540; }
.trade-table tr { cursor:pointer; transition:all .15s; }
.trade-table tr:hover { background:#1e1e35; }
.trade-table tr.trade-selected { background:#1a2a4e !important; border-left:3px solid #5b9bd5; }
.trade-table .badge { padding:2px 8px; border-radius:4px; font-size:11px; font-weight:600; }
.badge-win { background:rgba(239,83,80,.15); color:#ef5350; }
.badge-loss { background:rgba(38,166,154,.15); color:#26a69a; }
.badge-open { background:rgba(255,193,7,.15); color:#ffc107; }
.trade-reason-tip { position:relative; display:inline-block; }
.trade-reason-tip .tip-icon { display:inline-flex; align-items:center; justify-content:center; width:22px; height:22px; background:#2a2a4e; color:#7ec8e3; border-radius:50%; font-size:12px; font-weight:700; cursor:help; border:1px solid #3a3a5e; transition:all .2s; user-select:none; }
.trade-reason-tip:hover .tip-icon { background:#5b9bd5; color:#fff; border-color:#5b9bd5; }
.trade-reason-tip .tip-pop { display:none; position:absolute; bottom:calc(100% + 8px); right:0; width:360px; background:#252540; border:1px solid #3a3a5e; border-radius:8px; padding:12px 14px; font-size:11px; color:#ccc; line-height:1.7; z-index:9999; box-shadow:0 6px 24px rgba(0,0,0,.6); white-space:normal; word-break:break-word; text-align:left; }
.trade-reason-tip .tip-pop::after { content:''; position:absolute; top:100%; right:8px; border:6px solid transparent; border-top-color:#3a3a5e; }
.trade-reason-tip:hover .tip-pop { display:block; }
.table-wrap { max-height:500px; overflow-y:auto; border-radius:8px; border:1px solid #252540; }

/* Loading */
.loading { display:none; text-align:center; padding:40px; }
.loading.active { display:block; }
.spinner { width:40px; height:40px; border:3px solid #252540; border-top-color:#5b9bd5; border-radius:50%; animation:spin .8s linear infinite; margin:0 auto 16px; }
@keyframes spin { to { transform:rotate(360deg); } }

/* Hidden */
.hidden { display:none !important; }

/* Mode Toggle */
.mode-toggle { display:flex; align-items:center; gap:0; margin-bottom:16px; background:#252540; border-radius:8px; overflow:hidden; border:1px solid #3a3a5e; }
.mode-toggle button { flex:1; padding:10px 16px; background:transparent; border:none; color:#888; font-size:13px; font-weight:500; cursor:pointer; transition:all .2s; }
.mode-toggle button.active { background:#3a7bd5; color:#fff; }
.mode-toggle button:hover:not(.active) { color:#ccc; background:#2a2a4e; }
.auto-info { background:#16162a; border:1px solid #2a4a6e; border-radius:8px; padding:14px 18px; margin-bottom:16px; font-size:13px; color:#aaa; line-height:1.6; }
.auto-info strong { color:#f5c842; }
.params-section.auto-hidden { opacity:0.3; pointer-events:none; filter:grayscale(0.5); }

/* Recommendation Banner */
.recommend-banner { background:#1a2a3e; border:1px solid #2a4a6e; border-radius:8px; padding:14px 18px; margin-bottom:16px; font-size:13px; line-height:1.6; display:none; }
.recommend-banner.active { display:block; }
.recommend-banner .rec-title { color:#5b9bd5; font-weight:600; margin-bottom:6px; font-size:14px; }
.recommend-banner .rec-detail { color:#aaa; }
@keyframes rec-blink { 0%,100%{opacity:1;} 50%{opacity:0.15;} }
.recommend-banner .rec-title.rec-title-loading { animation: rec-blink 0.9s ease-in-out infinite; }
.recommend-banner .rec-highlight { color:#f5c842; font-weight:600; }
.recommend-banner .rec-actions { margin-top:10px; display:flex; gap:8px; }

/* Responsive */
@media(max-width:768px) {
  .stats-grid { grid-template-columns:repeat(4,1fr); }
  .params { grid-template-columns:1fr 1fr; }
  header h1 { font-size:22px; }
  .tooltip-content { width:260px; }
}
</style>
</head>
<body>
<div class="container">

<header>
  <h1>Stock Trading Simulator</h1>
  <p>ë²¤í¬ë“œ ë²•ì¹™ + ê¸°ìˆ ì  ë¶„ì„ ê¸°ë°˜ ë§¤ìˆ˜/ë§¤ë„ ì‹œë®¬ë ˆì´ì…˜ &nbsp;|&nbsp; Walk-forward Backtest</p>
</header>

<!-- Upload -->
<div class="card">
  <h2>1. XML ì£¼ê°€ ë°ì´í„° ì—…ë¡œë“œ</h2>
  <div style="display:flex; gap:12px; margin-bottom:16px; align-items:flex-end;">
    <div style="flex:1;">
      <label style="display:block; font-size:12px; color:#888; margin-bottom:4px;">ì¢…ëª©ì½”ë“œ ë˜ëŠ” ì¢…ëª©ëª… ì…ë ¥ â†’ ìë™ ë°ì´í„° ë¡œë“œ</label>
      <div style="display:flex; gap:8px;">
        <input type="text" id="symbolInput" placeholder="ì˜ˆ: 005930 ë˜ëŠ” ì‚¼ì„±ì „ì" style="flex:1; background:#252540; border:1px solid #3a3a5e; color:#fff; padding:8px 12px; border-radius:6px; font-size:14px;">
        <button class="btn btn-sm btn-outline" id="fetchBtn" style="white-space:nowrap;">ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°</button>
      </div>
    </div>
  </div>
  <div id="xmlLinkResult" style="display:none; background:#16162a; border:1px solid #252540; border-radius:8px; padding:12px 16px; margin-bottom:12px; font-size:13px;"></div>
  <div style="text-align:center; color:#555; font-size:12px; margin-bottom:12px;">â”€â”€ ë˜ëŠ” XML íŒŒì¼ ì—…ë¡œë“œ â”€â”€</div>
  <div id="uploadAreaWrap">
    <div class="upload-area" id="uploadArea">
      <div class="icon">ğŸ“‚</div>
      <p>XML íŒŒì¼ì„ ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•˜ì—¬ ì—…ë¡œë“œ</p>
      <div class="filename" id="fileName"></div>
    </div>
    <div id="globalOptToast">
      <span class="toast-text">âš™ ìë™ ìµœì í™” ì§„í–‰ ì¤‘...</span>
      <span class="toast-sub">6ê°œ íŒŒë¼ë¯¸í„° ì¡°í•© íƒìƒ‰ ì¤‘ì…ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.</span>
    </div>
  </div>
  <input type="file" id="fileInput" accept=".xml">

  <div class="instructions">
    <div class="instructions-toggle" onclick="this.classList.toggle('open');this.nextElementSibling.classList.toggle('open');">
      <span>ğŸ“‹ XML íŒŒì¼ ë§Œë“œëŠ” ë°©ë²• (ë„¤ì´ë²„ ì¦ê¶Œ)</span>
      <span class="toggle-arrow">â–¼</span>
    </div>
    <div class="instructions-body">
      <ol>
        <li><strong>ì¢…ëª©ì½”ë“œ í™•ì¸</strong> â€” ë„¤ì´ë²„ ì¦ê¶Œì—ì„œ ì›í•˜ëŠ” ì¢…ëª© ê²€ìƒ‰ í›„ URLì˜ ìˆ«ìê°€ ì¢…ëª©ì½”ë“œì…ë‹ˆë‹¤.
          <br>ì˜ˆ: <code>https://finance.naver.com/item/main.nhn?code=<strong>005930</strong></code> â†’ ì‚¼ì„±ì „ì = <strong>005930</strong></li>
        <li><strong>ì•„ë˜ URLì— ì¢…ëª©ì½”ë“œë¥¼ ë„£ê³ </strong> ë¸Œë¼ìš°ì € ì£¼ì†Œì°½ì— ì…ë ¥:
          <br><code>https://fchart.stock.naver.com/sise.nhn?symbol=<strong>ì¢…ëª©ì½”ë“œ</strong>&timeframe=day&count=5000&requestType=0</code>
          <br>ì˜ˆì‹œ: <code>https://fchart.stock.naver.com/sise.nhn?symbol=005930&timeframe=day&count=5000&requestType=0</code></li>
        <li><strong>í˜ì´ì§€ì—ì„œ Ctrl+S (ë˜ëŠ” Cmd+S)</strong>ë¡œ XML íŒŒì¼ ì €ì¥</li>
        <li>ì €ì¥í•œ <strong>.xml íŒŒì¼ì„ ìœ„ì— ì—…ë¡œë“œ</strong></li>
      </ol>
      <h3 style="color:#bbb; margin:12px 0 8px;">ìì£¼ ì‚¬ìš©í•˜ëŠ” ì¢…ëª©ì½”ë“œ</h3>
      <table>
        <tr><th>ì¢…ëª©</th><th>ì½”ë“œ</th><th>ì¢…ëª©</th><th>ì½”ë“œ</th><th>ì¢…ëª©</th><th>ì½”ë“œ</th></tr>
        <tr><td>ì‚¼ì„±ì „ì</td><td>005930</td><td>ì¹´ì¹´ì˜¤</td><td>035720</td><td>ë„¤ì´ë²„</td><td>035420</td></tr>
        <tr><td>ì¹´ì¹´ì˜¤í˜ì´</td><td>377300</td><td>ì‚¼ì„±SDI</td><td>006400</td><td>LGì—ë„ˆì§€ì†”ë£¨ì…˜</td><td>373220</td></tr>
        <tr><td>í˜„ëŒ€ì°¨</td><td>005380</td><td>SKí•˜ì´ë‹‰ìŠ¤</td><td>000660</td><td>ì…€íŠ¸ë¦¬ì˜¨</td><td>068270</td></tr>
        <tr><td>POSCOí™€ë”©ìŠ¤</td><td>005490</td><td>KBê¸ˆìœµ</td><td>105560</td><td>ì‚¼ì„±ë°”ì´ì˜¤ë¡œì§ìŠ¤</td><td>207940</td></tr>
      </table>
      <p style="margin-top:10px; color:#777;">â€» XML í˜•ì‹: <code>&lt;item data="ë‚ ì§œ|ì‹œê°€|ê³ ê°€|ì €ê°€|ì¢…ê°€|ê±°ë˜ëŸ‰" /&gt;</code> â€” ë„¤ì´ë²„ ì¦ê¶Œ ì°¨íŠ¸ APIì—ì„œ ìë™ ìƒì„±ë©ë‹ˆë‹¤.</p>
    </div>
  </div>
</div>

<!-- Parameters -->
<div class="card">
  <h2>2. ë§¤ë§¤ íŒŒë¼ë¯¸í„° ì„¤ì •</h2>
  <div class="mode-toggle">
    <button id="modeManual" onclick="setMode('manual')">ìˆ˜ë™ ì„¤ì •</button>
    <button id="modeAuto" class="active" onclick="setMode('auto')">ìë™ ìµœì í™” (ê¶Œì¥)</button>
  </div>
  <div class="auto-info" id="autoInfo">
    <strong>ìë™ ìµœì í™” ëª¨ë“œ</strong><br>
    XML ì—…ë¡œë“œ í›„ "ë¶„ì„ ì‹œì‘"ì„ ëˆ„ë¥´ë©´, ì£¼ê°€ ë³€ë™ì„±ì„ ë¶„ì„í•˜ì—¬ ì¢…ëª© íŠ¹ì„±ì— ë§ëŠ”<br>
    <strong>ìµì ˆ/ì†ì ˆ/ì¿¨ë‹¤ìš´/ë³´ìœ ì¼/ë²¤í¬ë“œìœˆë„ìš°/ì˜í–¥ë„/ìµœì†Œê°ì§€íšŸìˆ˜</strong> 6ê°œ íŒŒë¼ë¯¸í„°ì˜ ìµœì  ì¡°í•©ì„ ìë™ íƒìƒ‰í•©ë‹ˆë‹¤.<br>
    <span style="color:#666;">â€» ìµœì í™” í›„ íŒŒë¼ë¯¸í„°ë¥¼ ìˆ˜ë™ìœ¼ë¡œ ì¡°ì •í•œ ë’¤ "ë¶„ì„ ì‹œì‘"ì„ ëˆŒëŸ¬ë„ ë©ë‹ˆë‹¤.</span>
  </div>
  <div class="params" id="paramsSection">
    <div class="param-group">
      <label>
        ì¢…ëª© ìœ í˜•
        <span class="tooltip-wrap">
          <span class="tooltip-icon">?</span>
          <span class="tooltip-content">
            <div class="tip-title">ì¢…ëª© ìœ í˜•ì´ë€?</div>
            ëŒ€í˜•ì£¼(ì‚¼ì„±ì „ì, í˜„ëŒ€ì°¨ ë“±)ì™€ ì¤‘ì†Œí˜•ì£¼(ì¹´ì¹´ì˜¤í˜ì´, ì…€íŠ¸ë¦¬ì˜¨ ë“±)ëŠ” <strong>ë³€ë™ì„±ê³¼ ê±°ë˜ íŒ¨í„´</strong>ì´ í¬ê²Œ ë‹¤ë¦…ë‹ˆë‹¤.
            <br><br>
            <strong>ì¤‘ì†Œí˜•ì£¼</strong>: ë³€ë™ì„±ì´ í¬ê³ , ê¸‰ë“±/ê¸‰ë½ì´ ì¦ìŒ. ë†’ì€ ìµì ˆ(21%)ì„ ë…¸ë¦´ ìˆ˜ ìˆì§€ë§Œ ë¹ ë¥¸ ì†ì ˆ(7%)ì´ í•„ìš”.
            <br><br>
            <strong>ëŒ€í˜•ì£¼</strong>: ë³€ë™ì„±ì´ ë‚®ê³ , ì™„ë§Œí•œ ì¶”ì„¸. ë‚®ì€ ìµì ˆ(10%)ì— ë„‰ë„‰í•œ ì†ì ˆ(10%)ì´ ë” ì í•©. ëŒ€í˜•ì£¼ì— +21% ìµì ˆì„ ì„¤ì •í•˜ë©´ ë„ë‹¬ ìì²´ê°€ ì–´ë ¤ì›Œ ìŠ¹ë¥ ì´ ê¸‰ë½í•©ë‹ˆë‹¤.
            <div class="tip-recommend">ì„ íƒ ì‹œ ì•„ë˜ íŒŒë¼ë¯¸í„°ê°€ ê¶Œì¥ê°’ìœ¼ë¡œ ìë™ ë³€ê²½ë©ë‹ˆë‹¤.</div>
          </span>
        </span>
      </label>
      <select id="stockProfile">
        <option value="default">ì¼ë°˜ (ì¤‘ì†Œí˜• ì„±ì¥ì£¼)</option>
        <option value="large_cap">ëŒ€í˜• ìš°ëŸ‰ì£¼</option>
      </select>
    </div>
    <div class="param-group">
      <label>
        ìµì ˆ ê¸°ì¤€ (%)
        <span class="tooltip-wrap">
          <span class="tooltip-icon">?</span>
          <span class="tooltip-content">
            <div class="tip-title">ìµì ˆ(Take Profit)ì´ë€?</div>
            ë§¤ìˆ˜ í›„ ì£¼ê°€ê°€ ì´ ìˆ˜ì¹˜ë§Œí¼ <strong>ìƒìŠ¹í•˜ë©´ ìë™ìœ¼ë¡œ ë§¤ë„</strong>í•˜ì—¬ ì´ìµì„ ì‹¤í˜„í•©ë‹ˆë‹¤.
            <div class="tip-example">ì˜ˆ: 17% â†’ 10,000ì›ì— ë§¤ìˆ˜ ì‹œ 11,700ì›ì— ë„ë‹¬í•˜ë©´ ë§¤ë„</div>
            <div class="tip-recommend">
              ê¶Œì¥ê°’ â€” ì¤‘ì†Œí˜•ì£¼: 17% (ë³€ë™ì„± ì»¤ì„œ í° ìˆ˜ìµ ê°€ëŠ¥) | ëŒ€í˜•ì£¼: 10% (ë³€ë™ì„± ë‚®ì•„ í˜„ì‹¤ì  ëª©í‘œ)
            </div>
          </span>
        </span>
      </label>
      <input type="number" id="takeProfit" value="17" min="1" max="100" step="1">
    </div>
    <div class="param-group">
      <label>
        ì†ì ˆ ê¸°ì¤€ (%)
        <span class="tooltip-wrap">
          <span class="tooltip-icon">?</span>
          <span class="tooltip-content">
            <div class="tip-title">ì†ì ˆ(Stop Loss)ì´ë€?</div>
            ë§¤ìˆ˜ í›„ ì£¼ê°€ê°€ ì´ ìˆ˜ì¹˜ë§Œí¼ <strong>í•˜ë½í•˜ë©´ ìë™ìœ¼ë¡œ ë§¤ë„</strong>í•˜ì—¬ ì¶”ê°€ ì†ì‹¤ì„ ë°©ì§€í•©ë‹ˆë‹¤.
            <div class="tip-example">ì˜ˆ: 7% â†’ 10,000ì›ì— ë§¤ìˆ˜ ì‹œ 9,300ì›ì— ë„ë‹¬í•˜ë©´ ë§¤ë„</div>
            <div class="tip-recommend">
              ê¶Œì¥ê°’ â€” ì¤‘ì†Œí˜•ì£¼: 7% (ë¹ ë¥¸ ì†ì ˆë¡œ í° í•˜ë½ ë°©ì§€) | ëŒ€í˜•ì£¼: 10% (ì¼ì‹œì  ë³€ë™ì— íœ©ì“¸ë¦¬ì§€ ì•Šë„ë¡ ë„‰ë„‰í•˜ê²Œ)
            </div>
          </span>
        </span>
      </label>
      <input type="number" id="stopLoss" value="7" min="1" max="50" step="1">
    </div>
    <div class="param-group">
      <label>
        ì¿¨ë‹¤ìš´ (ì¼)
        <span class="tooltip-wrap">
          <span class="tooltip-icon">?</span>
          <span class="tooltip-content">
            <div class="tip-title">ì¿¨ë‹¤ìš´ì´ë€?</div>
            ë§¤ìˆ˜ ì‹œê·¸ë„ì´ ë°œìƒí•œ í›„ <strong>ë‹¤ìŒ ë§¤ìˆ˜ê¹Œì§€ ëŒ€ê¸°í•˜ëŠ” ì¼ìˆ˜</strong>ì…ë‹ˆë‹¤. ê°™ì€ ìƒìŠ¹ ì¶”ì„¸ì—ì„œ ì¤‘ë³µ ë§¤ìˆ˜ë¥¼ ë°©ì§€í•©ë‹ˆë‹¤.
            <div class="tip-example">ì˜ˆ: 3ì¼ â†’ ë§¤ìˆ˜ í›„ 3ê±°ë˜ì¼ ë™ì•ˆ ìƒˆ ì‹œê·¸ë„ì´ ë°œìƒí•´ë„ ë¬´ì‹œ</div>
            <div class="tip-recommend">
              ê¶Œì¥ê°’ â€” ì¤‘ì†Œí˜•ì£¼: 3ì¼ (ë¹ ë¥¸ ì¶”ì„¸ ë³€í™”ì— ëŒ€ì‘) | ëŒ€í˜•ì£¼: 5ì¼ (ëŠë¦° ì¶”ì„¸ì— ë§ì¶¤). ê°’ì„ ë†’ì´ë©´ ê±°ë˜ íšŸìˆ˜ ê°ì†Œ, ë‚®ì¶”ë©´ ì¦ê°€.
            </div>
          </span>
        </span>
      </label>
      <input type="number" id="cooldown" value="3" min="1" max="30" step="1">
    </div>
    <div class="param-group">
      <label>
        ë²¤í¬ë“œ ìœˆë„ìš° (ì¼)
        <span class="tooltip-wrap">
          <span class="tooltip-icon">?</span>
          <span class="tooltip-content">
            <div class="tip-title">ë²¤í¬ë“œ ìœˆë„ìš°ë€?</div>
            <strong>ë²¤í¬ë“œ ë²•ì¹™</strong> ë¶„ì„ + ì„¸ë ¥ ê°ì‹œì— ì‚¬ìš©í•˜ëŠ” ìµœê·¼ Nì¼ì˜ ë²”ìœ„ì…ë‹ˆë‹¤.
            <br><br>
            â‘  ê° ì¼ë´‰ì˜ ê±°ë˜ëŸ‰/ê°€ê²© <strong>ì²«ì§¸ìë¦¬ ìˆ«ì ë¶„í¬</strong>ë¥¼ ë¶„ì„í•˜ì—¬ ì´ìƒ ì—¬ë¶€ íŒì •
            <br>
            â‘¡ ì´ ìœˆë„ìš° ê¸°ê°„ ë‚´ì— ì´ìƒì¼ì´ <strong>ìµœì†Œ ê°ì§€íšŸìˆ˜ ì´ìƒ</strong>ì´ë©´ ì„¸ë ¥ ë§¤ì§‘ìœ¼ë¡œ íŒì •
            <br><br>
            <strong>15~20ì¼</strong>: ë‹¨ê¸° ì„¸ë ¥ ë§¤ì§‘ í¬ì°© (ë¯¼ê°)
            <br>
            <strong>30ì¼</strong>: ì¤‘ê¸° ë§¤ì§‘ íŒ¨í„´ ì¶”ì  (ê· í˜•)
            <br>
            <strong>45~60ì¼</strong>: ì¥ê¸° ë§¤ì§‘ ì¶”ì  (ì•ˆì •ì )
            <div class="tip-recommend">
              ê¶Œì¥ê°’: 30ì¼. ë¶„ì„ ì •í™•ë„ì™€ ì„¸ë ¥ ì¶”ì  ë²”ìœ„ì˜ ìµœì  ê· í˜•.
            </div>
          </span>
        </span>
      </label>
      <input type="number" id="benfordWindow" value="30" min="10" max="60" step="5">
    </div>
    <div class="param-group">
      <label>
        ë²¤í¬ë“œ ì˜í–¥ë„ (%)
        <span class="tooltip-wrap">
          <span class="tooltip-icon">?</span>
          <span class="tooltip-content">
            <div class="tip-title">ë²¤í¬ë“œ ì˜í–¥ë„ë€?</div>
            ë²¤í¬ë“œ ë²•ì¹™ ë¶„ì„ ê²°ê³¼ê°€ ë§¤ìˆ˜ ìŠ¤ì½”ì–´ì— ë¯¸ì¹˜ëŠ” <strong>ìµœëŒ€ ê°€ì¤‘ì¹˜</strong>ì…ë‹ˆë‹¤.
            <br><br>
            <strong>0%</strong>: ë²¤í¬ë“œ ë²•ì¹™ ì™„ì „ ë¹„í™œì„±í™” (ìˆœìˆ˜ ê¸°ìˆ ì  ë¶„ì„ë§Œ ì‚¬ìš©)
            <br>
            <strong>15%</strong>: ì´ìƒ íŒ¨í„´ ê°ì§€ ì‹œ ìŠ¤ì½”ì–´ ìµœëŒ€ +15% ê°€ì‚° (ê¸°ë³¸ê°’)
            <br>
            <strong>30%</strong>: ë²¤í¬ë“œ ì˜í–¥ ê·¹ëŒ€í™”
            <br><br>
            í˜„ì¬ ëª¨ë“œëŠ” <strong>ì–‘(+)ì˜ ê°€ì‚°</strong>ì…ë‹ˆë‹¤. ì´ë¯¸ ëª¨ë“  í•„ìˆ˜ ê¸°ìˆ ì  ì¡°ê±´ì„ í†µê³¼í•œ ì¢…ëª©ì—ì„œ ê±°ë˜ëŸ‰/ê°€ê²© íŒ¨í„´ì´ ë¹„ì •ìƒì´ë©´, ê¸°ê´€ì´ë‚˜ ì„¸ë ¥ì˜ ì˜ë„ì  ë§¤ì§‘ìœ¼ë¡œ í•´ì„í•˜ì—¬ ê°€ì‚°ì ì„ ì¤ë‹ˆë‹¤.
            <div class="tip-recommend">
              ê¶Œì¥ê°’: 15%. 0%ë¡œ ì„¤ì •í•˜ë©´ ë²¤í¬ë“œ ë²•ì¹™ ì—†ì´ ìˆœìˆ˜ ê¸°ìˆ ì  ë¶„ì„ë§Œ ì ìš©ë©ë‹ˆë‹¤.
            </div>
          </span>
        </span>
      </label>
      <input type="number" id="benfordInfluence" value="15" min="0" max="30" step="5">
    </div>
    <div class="param-group">
      <label>
        ì„¸ë ¥ ìµœì†Œ ê°ì§€íšŸìˆ˜
        <span class="tooltip-wrap">
          <span class="tooltip-icon">?</span>
          <span class="tooltip-content">
            <div class="tip-title">ì„¸ë ¥ ìµœì†Œ ê°ì§€íšŸìˆ˜ë€?</div>
            ë²¤í¬ë“œ ìœˆë„ìš° ê¸°ê°„ ë‚´ì— ë²¤í¬ë“œ ì´ìƒì´ <strong>ìµœì†Œ ëª‡ íšŒ</strong> ê°ì§€ë˜ì–´ì•¼ ì„¸ë ¥ ë§¤ì§‘ìœ¼ë¡œ íŒì •í• ì§€ ì„¤ì •í•©ë‹ˆë‹¤.
            <br><br>
            <strong>2íšŒ</strong>: ëŠìŠ¨í•œ ê¸°ì¤€ (ì‹œê·¸ë„ ë§ìŒ, ë…¸ì´ì¦ˆ ìœ„í—˜)
            <br>
            <strong>3~5íšŒ</strong>: ì„¸ë ¥ ë§¤ì§‘ ê°€ëŠ¥ì„± ë†’ì€ ìˆ˜ì¤€
            <br>
            <strong>7íšŒ+</strong>: í™•ì‹¤í•œ ì„¸ë ¥ ê°œì…ë§Œ í¬ì°© (ê¸°íšŒ ê°ì†Œ)
            <div class="tip-example">ì˜ˆ: ìœˆë„ìš° 30ì¼, ìµœì†Œ 3íšŒ â†’ 30ì¼ ì¤‘ 3ì¼ ì´ìƒ ë²¤í¬ë“œ ì´ìƒì´ë©´ ì„¸ë ¥ ë§¤ì§‘ íŒì •<br>ì„¸ë ¥ì€ ë§¤ì¼ ë§¤ì§‘í•˜ì§€ ì•Šìœ¼ë¯€ë¡œ "ì—°ì†"ì´ ì•„ë‹Œ "ëˆ„ì "ìœ¼ë¡œ ì¶”ì </div>
            <div class="tip-recommend">
              ê¶Œì¥ê°’: 3íšŒ. ë…¸ì´ì¦ˆë¥¼ ê±¸ëŸ¬ë‚´ë©´ì„œë„ ë§¤ì§‘ ì´ˆê¸°ë¥¼ í¬ì°©í•©ë‹ˆë‹¤.
            </div>
          </span>
        </span>
      </label>
      <input type="number" id="benfordMinHits" value="3" min="1" max="15" step="1">
    </div>
    <div class="param-group">
      <label>
        ë§¤ë§¤ ìˆ˜ìˆ˜ë£Œ (%)
        <span class="tooltip-wrap">
          <span class="tooltip-icon">?</span>
          <span class="tooltip-content">
            <div class="tip-title">ë§¤ë§¤ ìˆ˜ìˆ˜ë£Œë€?</div>
            ì¦ê¶Œì‚¬ì— ì§€ë¶ˆí•˜ëŠ” <strong>ë§¤ìˆ˜/ë§¤ë„ ê°ê°ì˜ ê±°ë˜ ìˆ˜ìˆ˜ë£Œìœ¨</strong>ì…ë‹ˆë‹¤.
            <br><br>
            <strong>ê³„ì‚°ì‹:</strong>
            <br>
            ë§¤ìˆ˜ë¹„ìš© = ë§¤ìˆ˜ê°€ Ã— (1 + ìˆ˜ìˆ˜ë£Œìœ¨)
            <br>
            ë§¤ë„ìˆ˜ì… = ë§¤ë„ê°€ Ã— (1 âˆ’ ìˆ˜ìˆ˜ë£Œìœ¨ âˆ’ ë§¤ë„ì„¸ìœ¨)
            <br>
            ìˆ˜ìµë¥  = (ë§¤ë„ìˆ˜ì… âˆ’ ë§¤ìˆ˜ë¹„ìš©) / ë§¤ìˆ˜ë¹„ìš© Ã— 100
            <div class="tip-example">ì˜ˆ: ìˆ˜ìˆ˜ë£Œ 0.015%, ì„¸ê¸ˆ 0.18% â†’ 10,000ì› ë§¤ìˆ˜ ì‹œ ë§¤ìˆ˜ë¹„ìš© 10,001.5ì›, ë§¤ë„ìˆ˜ì… 9,980.5ì›(10,000ì› ë§¤ë„ ì‹œ)</div>
            <div class="tip-recommend">
              ì˜¨ë¼ì¸: 0.015~0.03% | MTS(ëª¨ë°”ì¼): 0.003~0.01% | HTS: 0.01~0.015%
            </div>
          </span>
        </span>
      </label>
      <input type="number" id="commissionRate" value="0.015" min="0" max="1" step="0.005">
    </div>
    <div class="param-group">
      <label>
        ë§¤ë„ ì„¸ê¸ˆ (%)
        <span class="tooltip-wrap">
          <span class="tooltip-icon">?</span>
          <span class="tooltip-content">
            <div class="tip-title">ë§¤ë„ ì„¸ê¸ˆì´ë€?</div>
            ë§¤ë„ ì‹œì—ë§Œ ë¶€ê³¼ë˜ëŠ” <strong>ì¦ê¶Œê±°ë˜ì„¸ + ë†ì–´ì´ŒíŠ¹ë³„ì„¸</strong>ì…ë‹ˆë‹¤. ë§¤ìˆ˜ ì‹œì—ëŠ” ë¶€ê³¼ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
            <br><br>
            <strong>ì½”ìŠ¤í”¼</strong>: ì¦ê¶Œê±°ë˜ì„¸ 0.03% + ë†íŠ¹ì„¸ 0.15% = <strong>0.18%</strong>
            <br>
            <strong>ì½”ìŠ¤ë‹¥</strong>: ì¦ê¶Œê±°ë˜ì„¸ <strong>0.18%</strong> (ë†íŠ¹ì„¸ ì—†ìŒ)
            <br><br>
            <strong>ì´ ê±°ë˜ë¹„ìš© (ì™•ë³µ):</strong>
            <br>
            = ë§¤ìˆ˜ìˆ˜ìˆ˜ë£Œ + ë§¤ë„ìˆ˜ìˆ˜ë£Œ + ë§¤ë„ì„¸ê¸ˆ
            <br>
            = 0.015% + 0.015% + 0.18% = <strong>ì•½ 0.21%</strong>
            <div class="tip-recommend">
              ì½”ìŠ¤í”¼/ì½”ìŠ¤ë‹¥ ëª¨ë‘ 0.18%ê°€ ì¼ë°˜ì . ETFëŠ” ë¹„ê³¼ì„¸(0%).
            </div>
          </span>
        </span>
      </label>
      <input type="number" id="taxRate" value="0.18" min="0" max="1" step="0.01">
    </div>
    <div class="param-group">
      <label>
        ê±°ë˜ ìˆ˜ëŸ‰ (ì£¼)
        <span class="tooltip-wrap">
          <span class="tooltip-icon">?</span>
          <span class="tooltip-content">
            <div class="tip-title">ê±°ë˜ ìˆ˜ëŸ‰ì´ë€?</div>
            ë§¤ìˆ˜ ì‹œê·¸ë„ ë°œìƒ ì‹œ <strong>ë§¤ìˆ˜í•  ì£¼ì‹ ìˆ˜ëŸ‰</strong>ì…ë‹ˆë‹¤. ìˆ˜ìµê¸ˆ ê³„ì‚°ì— ë°˜ì˜ë©ë‹ˆë‹¤.
            <div class="tip-example">ì˜ˆ: 10ì£¼ â†’ 10,000ì› ì¢…ëª© ë§¤ìˆ˜ ì‹œ íˆ¬ìê¸ˆ 100,000ì›</div>
            <div class="tip-recommend">
              ê¸°ë³¸ê°’: 10ì£¼. íˆ¬ì ê·œëª¨ì— ë§ê²Œ ì¡°ì ˆí•˜ì„¸ìš”.
            </div>
          </span>
        </span>
      </label>
      <input type="number" id="quantity" value="10" min="1" max="10000" step="1">
    </div>
    <div class="param-group">
      <label>
        ë¶„ì„ ê¸°ê°„ (ê±°ë˜ì¼)
        <span class="tooltip-wrap">
          <span class="tooltip-icon">?</span>
          <span class="tooltip-content">
            <div class="tip-title">ë¶„ì„ ê¸°ê°„ì´ë€?</div>
            ë°ì´í„°ì˜ <strong>ë§ˆì§€ë§‰ ë‚ (í˜„ì¬ì¼)ë¡œë¶€í„° ëª‡ ê±°ë˜ì¼ ì „</strong>ë¶€í„° íˆ¬ìë¥¼ ì‹œì‘í• ì§€ ì„¤ì •í•©ë‹ˆë‹¤.
            <br><br>
            <strong>0</strong>: ì „ì²´ ê¸°ê°„ ë¶„ì„ (ê¸°ë³¸ê°’)
            <br>
            <strong>10</strong>: ìµœê·¼ 10ê±°ë˜ì¼ë§Œ
            <br>
            <strong>60</strong>: ìµœê·¼ ì•½ 3ê°œì›”
            <br>
            <strong>250</strong>: ìµœê·¼ ì•½ 1ë…„
            <div class="tip-example">ì˜ˆ: 100 â†’ ë°ì´í„° ë§ˆì§€ë§‰ì¼ ê¸°ì¤€ 100ê±°ë˜ì¼ ì „ë¶€í„° ë§¤ë§¤ ì‹œë®¬ë ˆì´ì…˜</div>
            <div class="tip-recommend">
              0ì´ë©´ ì „ì²´ ê¸°ê°„. ì§§ê²Œ ì„¤ì •í•˜ë©´ ìµœê·¼ ì‹œì¥ ìƒí™©ì— ëŒ€í•œ ì „ëµ ì„±ê³¼ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            </div>
          </span>
        </span>
      </label>
      <input type="number" id="analysisRange" value="10" min="0" max="99999" step="10">
      <div style="display:flex; gap:3px; margin-top:4px;">
        <button class="btn btn-sm btn-outline range-btn" onclick="document.getElementById('analysisRange').value=0" style="padding:3px 0; font-size:11px; flex:1;">ì „ì²´</button>
        <button class="btn btn-sm btn-outline range-btn" onclick="document.getElementById('analysisRange').value=60" style="padding:3px 0; font-size:11px; flex:1;">3ê°œì›”</button>
        <button class="btn btn-sm btn-outline range-btn" onclick="document.getElementById('analysisRange').value=250" style="padding:3px 0; font-size:11px; flex:1;">1ë…„</button>
        <button class="btn btn-sm btn-outline range-btn" onclick="document.getElementById('analysisRange').value=500" style="padding:3px 0; font-size:11px; flex:1;">2ë…„</button>
      </div>
    </div>
  </div>
  <div class="recommend-banner" id="recommendBanner"></div>
  <div style="text-align:center; margin-top:8px;">
    <button class="btn btn-primary" id="analyzeBtn" disabled>ë¶„ì„ ì‹œì‘</button>
  </div>
</div>

<!-- Loading -->
<div class="loading" id="loading">
  <div class="spinner"></div>
  <p id="loadingMsg">ë¶„ì„ ì¤‘... ê¸°ìˆ ì§€í‘œ ê³„ì‚° ë° ë°±í…ŒìŠ¤íŠ¸ ì‹¤í–‰</p>
</div>

<!-- Results (hidden until analysis) -->
<div id="results" class="hidden">

  <!-- Stats -->
  <div class="card">
    <h2>3. ë¶„ì„ ê²°ê³¼</h2>
    <div id="stockInfo" style="margin-bottom:16px; color:#aaa; font-size:14px;"></div>
    <div class="stats-grid" id="statsGrid"></div>
  </div>

  <!-- Chart -->
  <div class="card">
    <h2>4. ì°¨íŠ¸</h2>
    <div class="chart-legend">
      <span><span class="dot" style="background:#ef5350"></span> ì–‘ë´‰(ìƒìŠ¹)</span>
      <span><span class="dot" style="background:#26a69a"></span> ìŒë´‰(í•˜ë½)</span>
      <span><span class="dot" style="background:#f5c842"></span> MA5</span>
      <span><span class="dot" style="background:#2196f3"></span> MA20</span>
      <span><span class="dot" style="background:#e040fb"></span> MA60</span>
      <span>â–² ë§¤ìˆ˜ &nbsp; â–¼ ë§¤ë„</span>
    </div>
    <div id="chartContainer"></div>
    <div id="volumeContainer"></div>
    <div class="chart-controls">
      <button class="btn btn-sm btn-outline" id="btnShowAll">ì „ì²´ ë§ˆì»¤ í‘œì‹œ</button>
      <button class="btn btn-sm btn-outline" id="btnClearChart">ì°¨íŠ¸ ì´ˆê¸°í™”</button>
      <span style="font-size:12px; color:#666; margin-left:8px; line-height:30px;">ì•„ë˜ ê±°ë˜ í–‰ì„ í´ë¦­í•˜ë©´ í•´ë‹¹ êµ¬ê°„ìœ¼ë¡œ ì´ë™í•©ë‹ˆë‹¤</span>
    </div>
  </div>

  <!-- Trade Details -->
  <div class="card">
    <h2>5. ê±°ë˜ ìƒì„¸ ë‚´ì—­</h2>
    <div class="table-wrap">
      <table class="trade-table" id="tradeTable">
        <colgroup>
          <col style="width:44px">   <!-- # -->
          <col style="width:64px">   <!-- ê²°ê³¼ -->
          <col style="width:124px">  <!-- ë§¤ìˆ˜ì¼: "2024-05-20" ì—¬ìœ ìˆê²Œ -->
          <col style="width:122px">  <!-- ë§¤ìˆ˜ê°€: "190,000ì›" ì—¬ìœ ìˆê²Œ -->
          <col style="width:78px">   <!-- ìˆ˜ëŸ‰: "100ì£¼" -->
          <col style="width:96px">   <!-- íˆ¬ìê¸ˆ: "1,900ë§Œ" -->
          <col style="width:124px">  <!-- ë§¤ë„ì¼ -->
          <col style="width:122px">  <!-- ë§¤ë„ê°€ -->
          <col style="width:98px">   <!-- ìˆ˜ìµë¥ : "+12.76%" -->
          <col style="width:98px">   <!-- ìˆ˜ìµê¸ˆ: "+212ë§Œ" -->
          <col style="width:78px">   <!-- ë³´ìœ ì¼: header "ë³´ìœ ì¼" 3ì í™•ë³´ -->
          <col style="width:98px">   <!-- ì²­ì‚°ì‚¬ìœ : header 4ì í™•ë³´ -->
          <col style="width:82px">   <!-- ìŠ¤ì½”ì–´: header 3ì í™•ë³´ -->
          <col style="width:42px">   <!-- ê·¼ê±°: íˆ´íŒ ì•„ì´ì½˜ -->
          <col>                       <!-- spacer: ë‚˜ë¨¸ì§€ ê³µê°„ í¡ìˆ˜ -->
        </colgroup>
        <thead>
          <tr>
            <th>#</th><th>ê²°ê³¼</th><th>ë§¤ìˆ˜ì¼</th><th>ë§¤ìˆ˜ê°€</th><th>ìˆ˜ëŸ‰</th><th>íˆ¬ìê¸ˆ</th>
            <th>ë§¤ë„ì¼</th><th>ë§¤ë„ê°€</th><th>ìˆ˜ìµë¥ </th><th>ìˆ˜ìµê¸ˆ</th><th>ë³´ìœ ì¼</th>
            <th>ì²­ì‚°ì‚¬ìœ </th><th>ìŠ¤ì½”ì–´</th><th style="text-align:center">ê·¼ê±°</th><th class="spacer-th"></th>
          </tr>
        </thead>
        <tbody id="tradeBody"></tbody>
      </table>
    </div>
  </div>

  <!-- ë¶„ì„ ë°©ë²• ìƒì„¸ ì„¤ëª… -->
  <div class="card">
    <h2>6. ë¶„ì„ ë°©ë²• ìƒì„¸ ì„¤ëª…</h2>
    <div style="font-size:14px; line-height:2; color:#ccc;">

      <h3 style="color:#5b9bd5; margin:20px 0 12px; font-size:16px; border-bottom:1px solid #2a2a3e; padding-bottom:8px;">ì „ì²´ íë¦„ ìš”ì•½</h3>
      <div style="background:#16162a; border:1px solid #252540; border-radius:8px; padding:16px 20px; margin-bottom:16px;">
        <div style="text-align:center; font-size:13px; color:#aaa;">
          <span style="background:#252540; padding:6px 14px; border-radius:20px; color:#5b9bd5; font-weight:600;">XML ë°ì´í„° ë¡œë“œ</span>
          <span style="color:#555; margin:0 8px;">â†’</span>
          <span style="background:#252540; padding:6px 14px; border-radius:20px; color:#f5c842; font-weight:600;">ê¸°ìˆ ì§€í‘œ ê³„ì‚°</span>
          <span style="color:#555; margin:0 8px;">â†’</span>
          <span style="background:#252540; padding:6px 14px; border-radius:20px; color:#ff7043; font-weight:600;">KOSPI êµ­ë©´ í•„í„°</span>
          <span style="color:#555; margin:0 8px;">â†’</span>
          <span style="background:#252540; padding:6px 14px; border-radius:20px; color:#4caf50; font-weight:600;">ë§¤ìˆ˜ ìŠ¤ì½”ì–´ë§</span>
          <span style="color:#555; margin:0 8px;">â†’</span>
          <span style="background:#252540; padding:6px 14px; border-radius:20px; color:#ef5350; font-weight:600;">ë§¤ë„ íŒì •</span>
          <span style="color:#555; margin:0 8px;">â†’</span>
          <span style="background:#252540; padding:6px 14px; border-radius:20px; color:#e040fb; font-weight:600;">ê²°ê³¼ ì§‘ê³„</span>
        </div>
      </div>

      <h3 style="color:#5b9bd5; margin:20px 0 12px; font-size:16px; border-bottom:1px solid #2a2a3e; padding-bottom:8px;">STEP 1. ê¸°ìˆ ì§€í‘œ ê³„ì‚°</h3>
      <p>XMLë¡œ ë¶ˆëŸ¬ì˜¨ ì¼ë´‰ ë°ì´í„°(ë‚ ì§œ, ì‹œê°€, ê³ ê°€, ì €ê°€, ì¢…ê°€, ê±°ë˜ëŸ‰)ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ë‹¤ìŒ ê¸°ìˆ ì§€í‘œë¥¼ ê³„ì‚°í•©ë‹ˆë‹¤.</p>
      <table style="width:100%; border-collapse:collapse; margin:12px 0; font-size:13px;">
        <tr style="background:#252540; color:#aaa;">
          <th style="padding:8px 12px; text-align:left; border:1px solid #333;">ì§€í‘œ</th>
          <th style="padding:8px 12px; text-align:left; border:1px solid #333;">ì„¤ì •</th>
          <th style="padding:8px 12px; text-align:left; border:1px solid #333;">ì˜ë¯¸</th>
        </tr>
        <tr>
          <td style="padding:8px 12px; border:1px solid #333; color:#f5c842;">ì´ë™í‰ê· ì„  (MA)</td>
          <td style="padding:8px 12px; border:1px solid #333;">5ì¼, 20ì¼, 60ì¼</td>
          <td style="padding:8px 12px; border:1px solid #333;">ë‹¨ê¸°/ì¤‘ê¸°/ì¥ê¸° ì¶”ì„¸ ë°©í–¥. ì •ë°°ì—´(MA5>MA20>MA60)ì´ë©´ ê°•í•œ ìƒìŠ¹ ì¶”ì„¸</td>
        </tr>
        <tr>
          <td style="padding:8px 12px; border:1px solid #333; color:#f5c842;">RSI</td>
          <td style="padding:8px 12px; border:1px solid #333;">14ì¼ (Wilder ë°©ì‹)</td>
          <td style="padding:8px 12px; border:1px solid #333;">0~100 ì‚¬ì´ ê°’. 30 ì´í•˜ë©´ ê³¼ë§¤ë„(ë°˜ë“± ê°€ëŠ¥ì„±â†‘), 70 ì´ìƒì´ë©´ ê³¼ë§¤ìˆ˜(í•˜ë½ ê°€ëŠ¥ì„±â†‘)</td>
        </tr>
        <tr>
          <td style="padding:8px 12px; border:1px solid #333; color:#f5c842;">ë³¼ë¦°ì € ë°´ë“œ</td>
          <td style="padding:8px 12px; border:1px solid #333;">20ì¼, 2Ïƒ</td>
          <td style="padding:8px 12px; border:1px solid #333;">ê°€ê²©ì´ í•˜ë‹¨ ë°´ë“œì— ê°€ê¹Œìš¸ìˆ˜ë¡ ì €í‰ê°€, ìƒë‹¨ì´ë©´ ê³ í‰ê°€. BBìœ„ì¹˜(%)ë¡œ í‘œí˜„</td>
        </tr>
        <tr>
          <td style="padding:8px 12px; border:1px solid #333; color:#f5c842;">MACD</td>
          <td style="padding:8px 12px; border:1px solid #333;">12/26/9</td>
          <td style="padding:8px 12px; border:1px solid #333;">ì¶”ì„¸ ì „í™˜ ê°ì§€. MACDê°€ ì‹œê·¸ë„ì„ ì„ ìƒí–¥ëŒíŒŒí•˜ë©´ ê³¨ë“ í¬ë¡œìŠ¤(ë§¤ìˆ˜ ì‹ í˜¸)</td>
        </tr>
        <tr>
          <td style="padding:8px 12px; border:1px solid #333; color:#f5c842;">ê±°ë˜ëŸ‰ ë¹„ìœ¨</td>
          <td style="padding:8px 12px; border:1px solid #333;">20ì¼ í‰ê·  ëŒ€ë¹„</td>
          <td style="padding:8px 12px; border:1px solid #333;">í‰ì†Œ ëŒ€ë¹„ ê±°ë˜ëŸ‰ ë°°ìˆ˜. 1.2~3ë°°ê°€ ê±´ê°•í•œ ë§¤ìˆ˜ì„¸, 6ë°° ì´ìƒì€ ê³¼ì—´</td>
        </tr>
        <tr>
          <td style="padding:8px 12px; border:1px solid #333; color:#f5c842;">ìº”ë“¤ìŠ¤í‹± íŒ¨í„´</td>
          <td style="padding:8px 12px; border:1px solid #333;">í•´ë¨¸, ìƒìŠ¹ì¥ì•…í˜•</td>
          <td style="padding:8px 12px; border:1px solid #333;">í•˜ë½ í›„ ë°˜ì „ì„ ì•”ì‹œí•˜ëŠ” ìº”ë“¤ í˜•íƒœ. í•´ë¨¸=ê¸´ ì•„ë˜ê¼¬ë¦¬, ì¥ì•…í˜•=ì „ì¼ ìŒë´‰ì„ ê°ì‹¸ëŠ” ì–‘ë´‰</td>
        </tr>
      </table>

      <h3 style="color:#5b9bd5; margin:20px 0 12px; font-size:16px; border-bottom:1px solid #2a2a3e; padding-bottom:8px;">STEP 2. ë²¤í¬ë“œ ë²•ì¹™ (ì„¸ë ¥ ë§¤ì§‘ ê°ì§€)</h3>
      <p><strong style="color:#f5c842;">ë²¤í¬ë“œ ë²•ì¹™</strong>ì´ë€, ìì—°ì ìœ¼ë¡œ ë°œìƒí•œ ìˆ«ì ë°ì´í„°ì—ì„œ <strong>ì²«ì§¸ ìë¦¬ ìˆ«ìì˜ ë¶„í¬ê°€ ê· ë“±í•˜ì§€ ì•Šë‹¤</strong>ëŠ” ë²•ì¹™ì…ë‹ˆë‹¤.</p>
      <div style="background:#16162a; border:1px solid #252540; border-radius:8px; padding:14px 18px; margin:12px 0;">
        <div style="font-size:13px; color:#aaa;">ìì—°ì ì¸ ê±°ë˜ëŸ‰ì˜ ì²«ì§¸ ìë¦¬ ë¶„í¬ (ë²¤í¬ë“œ ë²•ì¹™)</div>
        <div style="font-size:13px; margin-top:6px;">
          <span style="color:#5b9bd5;">1</span>: 30.1% &nbsp;
          <span style="color:#5b9bd5;">2</span>: 17.6% &nbsp;
          <span style="color:#5b9bd5;">3</span>: 12.5% &nbsp;
          <span style="color:#5b9bd5;">4</span>: 9.7% &nbsp;
          <span style="color:#5b9bd5;">5</span>: 7.9% &nbsp;
          <span style="color:#5b9bd5;">6</span>: 6.7% &nbsp;
          <span style="color:#5b9bd5;">7</span>: 5.8% &nbsp;
          <span style="color:#5b9bd5;">8</span>: 5.1% &nbsp;
          <span style="color:#5b9bd5;">9</span>: 4.6%
        </div>
        <div style="font-size:12px; color:#888; margin-top:8px;">
          â†’ ìˆ«ì 1ì´ 30%ë¡œ ê°€ì¥ ë§ê³ , 9ê°€ 4.6%ë¡œ ê°€ì¥ ì ìŒ. <strong style="color:#f5c842;">ì´ ë¶„í¬ì—ì„œ í¬ê²Œ ë²—ì–´ë‚˜ë©´ ì¸ìœ„ì  ì¡°ì‘(ì„¸ë ¥ ë§¤ì§‘) ê°€ëŠ¥ì„±</strong>
        </div>
      </div>
      <p>ì´ ì‹œë®¬ë ˆì´í„°ëŠ” ì„¤ì •í•œ <strong>ë²¤í¬ë“œ ìœˆë„ìš°</strong>(ì˜ˆ: 30ì¼) ê¸°ê°„ ë™ì•ˆì˜ ê±°ë˜ëŸ‰ê³¼ ê°€ê²© ë³€ë™ì˜ ì²«ì§¸ ìë¦¬ ìˆ«ì ë¶„í¬ë¥¼ ë¶„ì„í•©ë‹ˆë‹¤.</p>
      <ul style="padding-left:20px; margin:8px 0;">
        <li>ì¹´ì´ì œê³±(Ï‡Â²) ê²€ì •ìœ¼ë¡œ ë²¤í¬ë“œ ë²•ì¹™ê³¼ì˜ í¸ì°¨ë¥¼ ì¸¡ì •</li>
        <li>í¸ì°¨ê°€ í° ë‚ (ì´ìƒì¼)ì´ ìœˆë„ìš° ë‚´ì— <strong>ìµœì†Œ ê°ì§€íšŸìˆ˜</strong> ì´ìƒ ë°œê²¬ë˜ë©´ â†’ <strong style="color:#ef5350;">ì„¸ë ¥ ë§¤ì§‘ íŒì •</strong></li>
        <li>ì„¸ë ¥ ë§¤ì§‘ íŒì • ì‹œ, ë§¤ìˆ˜ ìŠ¤ì½”ì–´ì— <strong>ë²¤í¬ë“œ ì˜í–¥ë„</strong>ë§Œí¼ ê°€ì‚°ì  ë¶€ì—¬</li>
      </ul>

      <h3 style="color:#5b9bd5; margin:20px 0 12px; font-size:16px; border-bottom:1px solid #2a2a3e; padding-bottom:8px;">STEP 3. ë§¤ìˆ˜ ìŠ¤ì½”ì–´ë§ (ì ìˆ˜ ê³„ì‚°)</h3>
      <p>ë§¤ì¼ ì•„ë˜ í•­ëª©ë“¤ì˜ ì ìˆ˜ë¥¼ í•©ì‚°í•˜ì—¬ <strong>ì´ ìŠ¤ì½”ì–´</strong>ë¥¼ ê³„ì‚°í•©ë‹ˆë‹¤. ìŠ¤ì½”ì–´ê°€ <strong style="color:#f5c842;">5.0ì  ì´ìƒ</strong>ì´ë©´ ë§¤ìˆ˜ ì‹œê·¸ë„ì´ ë°œìƒí•©ë‹ˆë‹¤.</p>

      <div style="margin:12px 0;">
        <div style="color:#4caf50; font-weight:600; margin:12px 0 8px;">íŒ¨í„´ A: ê³¼ë§¤ë„ ë°˜ë“± ë§¤ìˆ˜ (ìƒìŠ¹ì˜ 64%ê°€ ì´ íŒ¨í„´)</div>
        <table style="width:100%; border-collapse:collapse; font-size:13px;">
          <tr style="background:#252540; color:#aaa;">
            <th style="padding:6px 12px; text-align:left; border:1px solid #333;">í•­ëª©</th>
            <th style="padding:6px 12px; text-align:left; border:1px solid #333;">ì¡°ê±´</th>
            <th style="padding:6px 12px; text-align:center; border:1px solid #333;">ì ìˆ˜</th>
          </tr>
          <tr><td style="padding:6px 12px; border:1px solid #333;">RSI ê³¼ë§¤ë„</td><td style="padding:6px 12px; border:1px solid #333;">RSI &lt; 25 (ê·¹ê³¼ë§¤ë„)</td><td style="padding:6px 12px; border:1px solid #333; text-align:center; color:#4caf50;">+3.5</td></tr>
          <tr><td style="padding:6px 12px; border:1px solid #333;"></td><td style="padding:6px 12px; border:1px solid #333;">RSI &lt; 35 (ê³¼ë§¤ë„)</td><td style="padding:6px 12px; border:1px solid #333; text-align:center; color:#4caf50;">+3.0</td></tr>
          <tr><td style="padding:6px 12px; border:1px solid #333;"></td><td style="padding:6px 12px; border:1px solid #333;">RSI &lt; 45 (ì•½ê³¼ë§¤ë„)</td><td style="padding:6px 12px; border:1px solid #333; text-align:center; color:#4caf50;">+2.0</td></tr>
          <tr><td style="padding:6px 12px; border:1px solid #333;">BB ìœ„ì¹˜</td><td style="padding:6px 12px; border:1px solid #333;">í•˜ë‹¨ 15% ì´ë‚´</td><td style="padding:6px 12px; border:1px solid #333; text-align:center; color:#4caf50;">+2.5</td></tr>
          <tr><td style="padding:6px 12px; border:1px solid #333;"></td><td style="padding:6px 12px; border:1px solid #333;">í•˜ë‹¨ 30% ì´ë‚´</td><td style="padding:6px 12px; border:1px solid #333; text-align:center; color:#4caf50;">+2.0</td></tr>
          <tr><td style="padding:6px 12px; border:1px solid #333;">ìµœê·¼ 5ì¼ í•˜ë½</td><td style="padding:6px 12px; border:1px solid #333;">-8% ì´ìƒ ê¸‰ë½</td><td style="padding:6px 12px; border:1px solid #333; text-align:center; color:#4caf50;">+2.5</td></tr>
          <tr><td style="padding:6px 12px; border:1px solid #333;"></td><td style="padding:6px 12px; border:1px solid #333;">-4% ì´ìƒ í•˜ë½</td><td style="padding:6px 12px; border:1px solid #333; text-align:center; color:#4caf50;">+2.0</td></tr>
          <tr><td style="padding:6px 12px; border:1px solid #333;">ì—°ì† í•˜ë½ ë°˜ì „</td><td style="padding:6px 12px; border:1px solid #333;">3ì¼ ì´ìƒ ìŒë´‰ í›„ ì–‘ë´‰ ì „í™˜</td><td style="padding:6px 12px; border:1px solid #333; text-align:center; color:#4caf50;">+2.0</td></tr>
          <tr><td style="padding:6px 12px; border:1px solid #333;">20ì¼ ì €ì  ê·¼ì ‘</td><td style="padding:6px 12px; border:1px solid #333;">ì €ì  ëŒ€ë¹„ 2% ì´ë‚´</td><td style="padding:6px 12px; border:1px solid #333; text-align:center; color:#4caf50;">+1.5</td></tr>
          <tr><td style="padding:6px 12px; border:1px solid #333;">MA20 ì´ê²©</td><td style="padding:6px 12px; border:1px solid #333;">MA20 ëŒ€ë¹„ -8% ì´ê²©</td><td style="padding:6px 12px; border:1px solid #333; text-align:center; color:#4caf50;">+1.5</td></tr>
        </table>
      </div>

      <div style="margin:12px 0;">
        <div style="color:#2196f3; font-weight:600; margin:12px 0 8px;">íŒ¨í„´ B: ì¶”ì„¸ ì¶”ì¢… ë§¤ìˆ˜ (ìƒìŠ¹ì˜ 35%ê°€ ì´ íŒ¨í„´)</div>
        <table style="width:100%; border-collapse:collapse; font-size:13px;">
          <tr style="background:#252540; color:#aaa;">
            <th style="padding:6px 12px; text-align:left; border:1px solid #333;">í•­ëª©</th>
            <th style="padding:6px 12px; text-align:left; border:1px solid #333;">ì¡°ê±´</th>
            <th style="padding:6px 12px; text-align:center; border:1px solid #333;">ì ìˆ˜</th>
          </tr>
          <tr><td style="padding:6px 12px; border:1px solid #333;">ì´ë™í‰ê·  ì •ë°°ì—´</td><td style="padding:6px 12px; border:1px solid #333;">MA5 > MA20 > MA60</td><td style="padding:6px 12px; border:1px solid #333; text-align:center; color:#4caf50;">+2.0</td></tr>
          <tr><td style="padding:6px 12px; border:1px solid #333;">MA20 ê¸°ìš¸ê¸°</td><td style="padding:6px 12px; border:1px solid #333;">10ì¼ê°„ 3% ì´ìƒ ìƒìŠ¹</td><td style="padding:6px 12px; border:1px solid #333; text-align:center; color:#4caf50;">+1.5</td></tr>
          <tr><td style="padding:6px 12px; border:1px solid #333;">ì‹ ê³ ê°€ ê·¼ì ‘</td><td style="padding:6px 12px; border:1px solid #333;">20ì¼ ê³ ì  ëŒ€ë¹„ 3% ì´ë‚´</td><td style="padding:6px 12px; border:1px solid #333; text-align:center; color:#4caf50;">+1.0</td></tr>
        </table>
      </div>

      <div style="margin:12px 0;">
        <div style="color:#ffc107; font-weight:600; margin:12px 0 8px;">ê³µí†µ ì‹œê·¸ë„</div>
        <table style="width:100%; border-collapse:collapse; font-size:13px;">
          <tr style="background:#252540; color:#aaa;">
            <th style="padding:6px 12px; text-align:left; border:1px solid #333;">í•­ëª©</th>
            <th style="padding:6px 12px; text-align:left; border:1px solid #333;">ì¡°ê±´</th>
            <th style="padding:6px 12px; text-align:center; border:1px solid #333;">ì ìˆ˜</th>
          </tr>
          <tr><td style="padding:6px 12px; border:1px solid #333;">MACD ê³¨ë“ í¬ë¡œìŠ¤</td><td style="padding:6px 12px; border:1px solid #333;">MACDê°€ ì‹œê·¸ë„ì„  ìƒí–¥ëŒíŒŒ</td><td style="padding:6px 12px; border:1px solid #333; text-align:center; color:#4caf50;">+1.5</td></tr>
          <tr><td style="padding:6px 12px; border:1px solid #333;">ê±°ë˜ëŸ‰</td><td style="padding:6px 12px; border:1px solid #333;">í‰ê· ì˜ 1.2~3ë°°</td><td style="padding:6px 12px; border:1px solid #333; text-align:center; color:#4caf50;">+1.0</td></tr>
          <tr><td style="padding:6px 12px; border:1px solid #333;">ì–‘ë´‰</td><td style="padding:6px 12px; border:1px solid #333;">ì¢…ê°€ > ì‹œê°€</td><td style="padding:6px 12px; border:1px solid #333; text-align:center; color:#4caf50;">+0.5</td></tr>
          <tr><td style="padding:6px 12px; border:1px solid #333;">ìƒìŠ¹ì¥ì•…í˜•</td><td style="padding:6px 12px; border:1px solid #333;">ì „ì¼ ìŒë´‰ì„ ê°ì‹¸ëŠ” ì–‘ë´‰</td><td style="padding:6px 12px; border:1px solid #333; text-align:center; color:#4caf50;">+1.0</td></tr>
          <tr><td style="padding:6px 12px; border:1px solid #333; color:#ef5350;">5ì¼ ê¸‰ë“± ì£¼ì˜</td><td style="padding:6px 12px; border:1px solid #333;">5ì¼ê°„ 15% ì´ìƒ ìƒìŠ¹</td><td style="padding:6px 12px; border:1px solid #333; text-align:center; color:#ef5350;">-1.5</td></tr>
        </table>
      </div>

      <div style="background:#16162a; border:1px solid #2a4a6e; border-radius:8px; padding:14px 18px; margin:16px 0;">
        <div style="color:#f5c842; font-weight:600; margin-bottom:6px;">ìŠ¤ì½”ì–´ ì˜ˆì‹œ</div>
        <div style="font-size:13px; color:#aaa;">
          RSI 32(ê³¼ë§¤ë„ +3.0) + BBìœ„ì¹˜ 22%(+2.0) + 5ì¼í•˜ë½ -5%(+2.0) + MACDê³¨ë“ í¬ë¡œìŠ¤(+1.5) + ì–‘ë´‰(+0.5)<br>
          = <strong style="color:#4caf50;">ì´ 9.0ì </strong> â†’ 5.0ì  ì´ìƒì´ë¯€ë¡œ <strong style="color:#ef5350;">ë§¤ìˆ˜ ì‹œê·¸ë„ ë°œìƒ!</strong>
        </div>
      </div>

      <h3 style="color:#5b9bd5; margin:20px 0 12px; font-size:16px; border-bottom:1px solid #2a2a3e; padding-bottom:8px;">STEP 4. ë§¤ë„ íŒì • (ìµì ˆ/ì†ì ˆ)</h3>
      <p>ë§¤ìˆ˜ í›„, ë§¤ì¼ì˜ ê³ ê°€Â·ì €ê°€ë¥¼ í™•ì¸í•˜ì—¬ ë‹¤ìŒ ì¡°ê±´ì— ë„ë‹¬í•˜ë©´ ìë™ ë§¤ë„í•©ë‹ˆë‹¤.</p>
      <table style="width:100%; border-collapse:collapse; font-size:13px; margin:12px 0;">
        <tr style="background:#252540; color:#aaa;">
          <th style="padding:8px 12px; text-align:left; border:1px solid #333;">êµ¬ë¶„</th>
          <th style="padding:8px 12px; text-align:left; border:1px solid #333;">ì¡°ê±´</th>
          <th style="padding:8px 12px; text-align:left; border:1px solid #333;">ì˜ˆì‹œ (10,000ì› ë§¤ìˆ˜)</th>
        </tr>
        <tr>
          <td style="padding:8px 12px; border:1px solid #333; color:#4caf50; font-weight:600;">ìµì ˆ (Take Profit)</td>
          <td style="padding:8px 12px; border:1px solid #333;">ê³ ê°€ê°€ ë§¤ìˆ˜ê°€ Ã— (1 + ìµì ˆë¥ )ì— ë„ë‹¬</td>
          <td style="padding:8px 12px; border:1px solid #333;">ìµì ˆ 17% â†’ ê³ ê°€ê°€ 11,700ì› ë„ë‹¬ ì‹œ ë§¤ë„</td>
        </tr>
        <tr>
          <td style="padding:8px 12px; border:1px solid #333; color:#ef5350; font-weight:600;">ì†ì ˆ (Stop Loss)</td>
          <td style="padding:8px 12px; border:1px solid #333;">ì €ê°€ê°€ ë§¤ìˆ˜ê°€ Ã— (1 - ì†ì ˆë¥ )ì— ë„ë‹¬</td>
          <td style="padding:8px 12px; border:1px solid #333;">ì†ì ˆ 7% â†’ ì €ê°€ê°€ 9,300ì› ë„ë‹¬ ì‹œ ë§¤ë„</td>
        </tr>
        <tr>
          <td style="padding:8px 12px; border:1px solid #333; color:#ffc107; font-weight:600;">ë™ì‹œ ë„ë‹¬</td>
          <td style="padding:8px 12px; border:1px solid #333;">ê°™ì€ ë‚  ìµì ˆÂ·ì†ì ˆ ëª¨ë‘ ë„ë‹¬</td>
          <td style="padding:8px 12px; border:1px solid #333;">ë³´ìˆ˜ì ìœ¼ë¡œ ì†ì ˆ ì²˜ë¦¬ (ì‹œê°€ ê¸°ì¤€ ì¬íŒë‹¨)</td>
        </tr>
      </table>
      <p style="font-size:13px; color:#888;">â€» ìˆ˜ìˆ˜ë£Œ(ë§¤ìˆ˜Â·ë§¤ë„)ì™€ ë§¤ë„ì„¸ê¸ˆì´ ë°˜ì˜ëœ ì‹¤ì§ˆ ìˆ˜ìµë¥ ë¡œ ìµœì¢… ìŠ¹/íŒ¨ë¥¼ íŒì •í•©ë‹ˆë‹¤.</p>

      <h3 style="color:#5b9bd5; margin:20px 0 12px; font-size:16px; border-bottom:1px solid #2a2a3e; padding-bottom:8px;">STEP 5. ìë™ ìµœì í™” (ì›Œí¬í¬ì›Œë“œ ê²€ì¦)</h3>
      <p>ìë™ ìµœì í™” ëª¨ë“œì—ì„œëŠ” <strong>ê³¼ì í•©ì„ ë°©ì§€</strong>í•˜ê¸° ìœ„í•´ ì›Œí¬í¬ì›Œë“œ(Walk-Forward) ë°©ì‹ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.</p>
      <div style="background:#16162a; border:1px solid #252540; border-radius:8px; padding:14px 18px; margin:12px 0; font-size:13px;">
        <div style="margin-bottom:8px;">
          <span style="color:#2196f3; font-weight:600;">1ë‹¨ê³„ â€” ë³€ë™ì„± ë¶„ì„</span><br>
          <span style="color:#aaa;">ì¼í‰ê·  ATR(ë³€ë™í­)ì„ ì¸¡ì •í•˜ì—¬ ì¢…ëª©ì˜ ë³€ë™ì„± ë“±ê¸‰ì„ ìë™ íŒë³„í•©ë‹ˆë‹¤. ì´ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ìµì ˆ/ì†ì ˆ íƒìƒ‰ ë²”ìœ„ë¥¼ ê²°ì •í•©ë‹ˆë‹¤.</span>
        </div>
        <div style="margin-bottom:8px;">
          <span style="color:#2196f3; font-weight:600;">2ë‹¨ê³„ â€” í›ˆë ¨ êµ¬ê°„ì—ì„œ íŒŒë¼ë¯¸í„° íƒìƒ‰</span><br>
          <span style="color:#aaa;">ë°ì´í„°ì˜ ì•ë¶€ë¶„(70%)ì„ í›ˆë ¨ êµ¬ê°„ìœ¼ë¡œ ì‚¬ìš©í•˜ì—¬, ìµì ˆ/ì†ì ˆ/ì¿¨ë‹¤ìš´/ë²¤í¬ë“œ ìœˆë„ìš°/ì˜í–¥ë„/ìµœì†Œê°ì§€íšŸìˆ˜ 6ê°œ íŒŒë¼ë¯¸í„°ì˜ ëª¨ë“  ì¡°í•©ì„ ì‹œë®¬ë ˆì´ì…˜í•©ë‹ˆë‹¤. ë‘ ê°€ì§€ ê¸°ì¤€ìœ¼ë¡œ ìµœì  ì¡°í•©ì„ ë™ì‹œì— íƒìƒ‰í•©ë‹ˆë‹¤:</span>
          <div style="margin:6px 0 0 12px; color:#aaa;">
            <span style="color:#f5c842;">ì•ˆì •í˜•(ìŠ¹ë¥ )</span> â€” ìŠ¹ë¥ ì´ ê°€ì¥ ë†’ì€ ì¡°í•©. ìì£¼ ì´ê¸°ëŠ” ê²ƒì´ ëª©í‘œ.<br>
            <span style="color:#e040fb;">ìˆ˜ìµí˜•(ìˆ˜ìµë¥ )</span> â€” í‰ê· ìˆ˜ìµë¥ ì´ ê°€ì¥ ë†’ì€ ì¡°í•©. í•œ ë²ˆ ì´ê¸¸ ë•Œ í¬ê²Œ ë¨¹ëŠ” ê²ƒì´ ëª©í‘œ.
          </div>
        </div>
        <div style="margin-bottom:8px;">
          <span style="color:#2196f3; font-weight:600;">3ë‹¨ê³„ â€” í…ŒìŠ¤íŠ¸ êµ¬ê°„ì—ì„œ ê²€ì¦</span><br>
          <span style="color:#aaa;">ë°ì´í„°ì˜ ë’·ë¶€ë¶„(30%)ì€ í›ˆë ¨ì— ì‚¬ìš©í•˜ì§€ ì•Šì€ "ë¯¸ë˜" ë°ì´í„°ì…ë‹ˆë‹¤. ì—¬ê¸°ì„œ ë™ì¼í•œ íŒŒë¼ë¯¸í„°ë¡œ ì‹œë®¬ë ˆì´ì…˜í•˜ì—¬ ì‹¤ì „ ì„±ê³¼ë¥¼ ì¶”ì •í•©ë‹ˆë‹¤. í›ˆë ¨ê³¼ í…ŒìŠ¤íŠ¸ ìŠ¹ë¥ ì´ ë¹„ìŠ·í•˜ë©´ ì‹ ë¢°ë„ê°€ ë†’ìŠµë‹ˆë‹¤.</span>
        </div>
        <div>
          <span style="color:#2196f3; font-weight:600;">4ë‹¨ê³„ â€” ì „ëµ ì„ íƒ</span><br>
          <span style="color:#aaa;"><strong style="color:#f5c842;">ì•ˆì •í˜•(ìŠ¹ë¥ )</strong>ê³¼ <strong style="color:#e040fb;">ìˆ˜ìµí˜•(ìˆ˜ìµë¥ )</strong> ë‘ ë²„íŠ¼ ì¤‘ ì›í•˜ëŠ” ì „ëµì„ í´ë¦­í•˜ë©´ í•´ë‹¹ ìµœì  íŒŒë¼ë¯¸í„°ê°€ ìë™ ì ìš©ë©ë‹ˆë‹¤. ì´í›„ "ë¶„ì„ ì‹œì‘"ì„ ëˆ„ë¥´ë©´ ì„ íƒí•œ íŒŒë¼ë¯¸í„°ë¡œ ë°±í…ŒìŠ¤íŠ¸ê°€ ì‹¤í–‰ë©ë‹ˆë‹¤.</span>
        </div>
      </div>

      <h3 style="color:#ff7043; margin:20px 0 12px; font-size:16px; border-bottom:1px solid #2a2a3e; padding-bottom:8px;">STEP 6. KOSPI ì‹œì¥ êµ­ë©´ í•„í„° (Option A â€” ì•½ì„¸ Hard Block)</h3>
      <p>ë§¤ìˆ˜ ìŠ¤ì½”ì–´ê°€ ì•„ë¬´ë¦¬ ë†’ì•„ë„, <strong style="color:#ff7043;">KOSPI ì „ì²´ ì‹œì¥ì´ ì•½ì„¸ êµ­ë©´ì´ë©´ ë§¤ìˆ˜ë¥¼ ì°¨ë‹¨</strong>í•©ë‹ˆë‹¤. ê°œë³„ ì¢…ëª©ì˜ ë‹¨ê¸° ë°˜ë“± ì‹ í˜¸ê°€ "ë–¨ì–´ì§€ëŠ” ì¹¼ë‚ "ì¼ ìˆ˜ ìˆê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.</p>

      <div style="background:#16162a; border:1px solid #3a2a1e; border-radius:8px; padding:14px 18px; margin:14px 0;">
        <div style="color:#f5c842; font-weight:600; margin-bottom:10px;">ê²€ì¦ ê·¼ê±° â€” 15ì¢…ëª© Ã— 2013~2026 ë°±í…ŒìŠ¤íŠ¸</div>
        <table style="width:100%; border-collapse:collapse; font-size:13px;">
          <tr style="background:#252540; color:#aaa;">
            <th style="padding:6px 12px; border:1px solid #333;">KOSPI êµ­ë©´</th>
            <th style="padding:6px 12px; border:1px solid #333; text-align:center;">ê±°ë˜ìˆ˜</th>
            <th style="padding:6px 12px; border:1px solid #333; text-align:center;">ìŠ¹ë¥ </th>
            <th style="padding:6px 12px; border:1px solid #333; text-align:center;">í‰ê· ìˆ˜ìµ</th>
            <th style="padding:6px 12px; border:1px solid #333; text-align:center;">ëˆ„ì </th>
          </tr>
          <tr>
            <td style="padding:6px 12px; border:1px solid #333; color:#4caf50; font-weight:600;">ê°•ì„¸</td>
            <td style="padding:6px 12px; border:1px solid #333; text-align:center;">1,048ê±´</td>
            <td style="padding:6px 12px; border:1px solid #333; text-align:center; color:#4caf50;">39.3%</td>
            <td style="padding:6px 12px; border:1px solid #333; text-align:center; color:#4caf50;">+2.44%</td>
            <td style="padding:6px 12px; border:1px solid #333; text-align:center; color:#4caf50;">ì–‘ìˆ˜</td>
          </tr>
          <tr>
            <td style="padding:6px 12px; border:1px solid #333; color:#f5c842;">íš¡ë³´</td>
            <td style="padding:6px 12px; border:1px solid #333; text-align:center;">490ê±´</td>
            <td style="padding:6px 12px; border:1px solid #333; text-align:center; color:#f5c842;">38.8%</td>
            <td style="padding:6px 12px; border:1px solid #333; text-align:center; color:#f5c842;">+2.31%</td>
            <td style="padding:6px 12px; border:1px solid #333; text-align:center; color:#f5c842;">ì–‘ìˆ˜</td>
          </tr>
          <tr style="background:#2a1a1a;">
            <td style="padding:6px 12px; border:1px solid #333; color:#ef5350; font-weight:600;">ì•½ì„¸ â†’ ì°¨ë‹¨</td>
            <td style="padding:6px 12px; border:1px solid #333; text-align:center;">223ê±´</td>
            <td style="padding:6px 12px; border:1px solid #333; text-align:center; color:#ef5350; font-weight:600;">27.8%</td>
            <td style="padding:6px 12px; border:1px solid #333; text-align:center; color:#ef5350; font-weight:600;">-0.33%</td>
            <td style="padding:6px 12px; border:1px solid #333; text-align:center; color:#ef5350; font-weight:600;">-85.8%</td>
          </tr>
        </table>
        <div style="font-size:12px; color:#888; margin-top:8px;">
          â†’ ì•½ì„¸ êµ¬ê°„ 223ê±´ ì°¨ë‹¨ ì‹œ: ì‚¼ì„±ì „ì ëˆ„ì ìˆ˜ìµ <strong style="color:#4caf50;">+52,260%p ê°œì„ </strong>, ì¹´ì¹´ì˜¤í˜ì´ ëˆ„ì ìˆ˜ìµ <strong style="color:#4caf50;">+8.6%p ê°œì„ </strong>
        </div>
      </div>

      <p style="margin-top:10px;">ì•½ì„¸ êµ­ë©´ íŒì •ì€ KOSPIì˜ 4ê°€ì§€ ì§€í‘œë¥¼ í•©ì‚°í•œ <strong>bad score</strong>ë¡œ ê²°ì •ë©ë‹ˆë‹¤.</p>
      <table style="width:100%; border-collapse:collapse; font-size:13px; margin:12px 0;">
        <tr style="background:#252540; color:#aaa;">
          <th style="padding:6px 12px; text-align:left; border:1px solid #333;">íŒì • ì¡°ê±´</th>
          <th style="padding:6px 12px; text-align:left; border:1px solid #333;">ê¸°ì¤€</th>
          <th style="padding:6px 12px; text-align:center; border:1px solid #333;">ì ìˆ˜</th>
        </tr>
        <tr>
          <td style="padding:6px 12px; border:1px solid #333;">MA ì—­ë°°ì—´</td>
          <td style="padding:6px 12px; border:1px solid #333;">KOSPI MA20 &lt; MA60</td>
          <td style="padding:6px 12px; border:1px solid #333; text-align:center; color:#ef5350;">+2</td>
        </tr>
        <tr>
          <td style="padding:6px 12px; border:1px solid #333;">MA60 í•˜ë½</td>
          <td style="padding:6px 12px; border:1px solid #333;">20ì¼ ê¸°ìš¸ê¸° &lt; -2%</td>
          <td style="padding:6px 12px; border:1px solid #333; text-align:center; color:#ef5350;">+2</td>
        </tr>
        <tr>
          <td style="padding:6px 12px; border:1px solid #333;">60ì¼ ìˆ˜ìµë¥  ë¶€ì§„</td>
          <td style="padding:6px 12px; border:1px solid #333;">60ì¼ ìˆ˜ìµë¥  &lt; -10%</td>
          <td style="padding:6px 12px; border:1px solid #333; text-align:center; color:#ef5350;">+2</td>
        </tr>
        <tr>
          <td style="padding:6px 12px; border:1px solid #333;">52ì£¼ ê³ ì  ë‚™í­</td>
          <td style="padding:6px 12px; border:1px solid #333;">52ì£¼ ê³ ì  ëŒ€ë¹„ -20% ì´í•˜</td>
          <td style="padding:6px 12px; border:1px solid #333; text-align:center; color:#ef5350;">+2</td>
        </tr>
        <tr style="background:#1a2a1a;">
          <td style="padding:6px 12px; border:1px solid #333; color:#ef5350; font-weight:600;" colspan="2">í•©ì‚° 5ì  ì´ìƒ â†’ ì•½ì„¸ íŒì • â†’ ë§¤ìˆ˜ ì „ë©´ ì°¨ë‹¨</td>
          <td style="padding:6px 12px; border:1px solid #333; text-align:center; color:#ef5350; font-weight:600;">â‰¥ 5ì </td>
        </tr>
      </table>
      <p style="font-size:13px; color:#888; margin-top:4px;">â€» í•œê³„: ê¸‰ë½ ì´ˆê¸°(COVID í­ë½ ì²« ë‹¬ ë“±) í›„í–‰ ì§€í‘œ íŠ¹ì„±ìƒ ì°¨ë‹¨ì´ ë‹¤ì†Œ ëŠ¦ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë‹¨, ì¥ê¸° í•˜ë½ì¥(2018, 2022 ë“±)ì€ íš¨ê³¼ì ìœ¼ë¡œ ì°¨ë‹¨í•©ë‹ˆë‹¤.</p>

      <h3 style="color:#5b9bd5; margin:20px 0 12px; font-size:16px; border-bottom:1px solid #2a2a3e; padding-bottom:8px;">í•µì‹¬ ì „ëµ ì² í•™</h3>
      <div style="background:#16162a; border:1px solid #252540; border-radius:8px; padding:14px 18px; margin:12px 0; font-size:13px; color:#aaa; line-height:1.8;">
        <div style="margin-bottom:10px;">
          <strong style="color:#f5c842;">ë“€ì–¼ ì—”ì§„ ì „ëµ</strong> â€” ì‹¤ì œ 3ì¢…ëª©, 104ê°œ 10%+ ìƒìŠ¹ ì‚¬ë¡€ë¥¼ ë¶„ì„í•œ ê²°ê³¼:
        </div>
        <ul style="padding-left:20px; margin:0;">
          <li>ìƒìŠ¹ì˜ <strong style="color:#4caf50;">64%</strong>ëŠ” RSI 50 ì´í•˜(ê³¼ë§¤ë„ ìƒíƒœ)ì—ì„œ ì‹œì‘ â†’ <strong>ê³¼ë§¤ë„ ë°˜ë“± ë§¤ìˆ˜</strong></li>
          <li>ìƒìŠ¹ì˜ <strong style="color:#4caf50;">87%</strong>ëŠ” ì§ì „ 5ì¼ ìˆ˜ìµì´ ë§ˆì´ë„ˆìŠ¤ â†’ <strong>í•˜ë½ í›„ ë°˜ë“± í¬ì°©</strong></li>
          <li>ìƒìŠ¹ì˜ <strong style="color:#4caf50;">71%</strong>ëŠ” ìŒë´‰ë‚ (í•˜ë½í•œ ë‚ ) ì‹œì‘ â†’ <strong>ê³µí¬ì— ë§¤ìˆ˜</strong></li>
          <li>ìƒìŠ¹ì˜ <strong style="color:#2196f3;">35%</strong>ëŠ” ì´ë¯¸ ìƒìŠ¹ ì¶”ì„¸ ì¤‘ ê°€ì† â†’ <strong>ì¶”ì„¸ ì¶”ì¢… ë§¤ìˆ˜</strong></li>
        </ul>
        <div style="margin-top:10px; color:#5b9bd5;">
          â†’ ë‘ ê°€ì§€ íŒ¨í„´ì„ ëª¨ë‘ í¬ì°©í•˜ì—¬, "ë°”ë‹¥ì—ì„œ ì¤ê¸°"ì™€ "íë¦„ì„ íƒ€ê¸°"ë¥¼ ë™ì‹œì— ì‹¤í–‰í•©ë‹ˆë‹¤.
        </div>
      </div>

      <h3 style="color:#5b9bd5; margin:20px 0 12px; font-size:16px; border-bottom:1px solid #2a2a3e; padding-bottom:8px;">ìˆ˜ìˆ˜ë£ŒÂ·ì„¸ê¸ˆ ê³„ì‚°</h3>
      <table style="width:100%; border-collapse:collapse; font-size:13px; margin:12px 0;">
        <tr style="background:#252540; color:#aaa;">
          <th style="padding:8px 12px; text-align:left; border:1px solid #333;">í•­ëª©</th>
          <th style="padding:8px 12px; text-align:left; border:1px solid #333;">ê³„ì‚°ì‹</th>
        </tr>
        <tr>
          <td style="padding:8px 12px; border:1px solid #333;">ë§¤ìˆ˜ ë¹„ìš©</td>
          <td style="padding:8px 12px; border:1px solid #333;">ë§¤ìˆ˜ê°€ Ã— (1 + ìˆ˜ìˆ˜ë£Œìœ¨) Ã— ìˆ˜ëŸ‰</td>
        </tr>
        <tr>
          <td style="padding:8px 12px; border:1px solid #333;">ë§¤ë„ ìˆ˜ì…</td>
          <td style="padding:8px 12px; border:1px solid #333;">ë§¤ë„ê°€ Ã— (1 âˆ’ ìˆ˜ìˆ˜ë£Œìœ¨ âˆ’ ë§¤ë„ì„¸ìœ¨) Ã— ìˆ˜ëŸ‰</td>
        </tr>
        <tr>
          <td style="padding:8px 12px; border:1px solid #333;">ì‹¤ì§ˆ ìˆ˜ìµë¥ </td>
          <td style="padding:8px 12px; border:1px solid #333;">(ë§¤ë„ìˆ˜ì… âˆ’ ë§¤ìˆ˜ë¹„ìš©) / ë§¤ìˆ˜ë¹„ìš© Ã— 100%</td>
        </tr>
      </table>

      <div style="background:#16162a; border:1px solid #2a4a6e; border-radius:8px; padding:14px 18px; margin:16px 0; font-size:12px; color:#888;">
        <strong style="color:#f5c842;">âš  ìœ ì˜ì‚¬í•­</strong><br>
        ì´ ì‹œë®¬ë ˆì´í„°ëŠ” ê³¼ê±° ë°ì´í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ í•œ ë°±í…ŒìŠ¤íŠ¸ ë„êµ¬ì…ë‹ˆë‹¤. ê³¼ê±° ì„±ê³¼ê°€ ë¯¸ë˜ ìˆ˜ìµì„ ë³´ì¥í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.<br>
        ì‹¤ì œ íˆ¬ì ì‹œì—ëŠ” ì‹œì¥ ìƒí™©, ìœ ë™ì„±, ìŠ¬ë¦¬í”¼ì§€ ë“± ì¶”ê°€ ìš”ì¸ì„ ë°˜ë“œì‹œ ê³ ë ¤í•˜ì„¸ìš”.
      </div>

    </div>
  </div>

</div>

</div>

<script>
// ============================================================
// 0. ì¢…ëª© í”„ë¡œí•„ (Python signal_engine.py STOCK_PROFILES ë¯¸ëŸ¬)
// ============================================================
const STOCK_PROFILES = {
  default: {
    highDistMax: 0.05, ma20SlopeMin: 0.02, volOverheat: 8.0,
    rsiOptimal: [50, 65], rsiForming: [45, 50],
    ret20dStrong: 0.15, ret20dMid: 0.10, ret20dWeak: 0.05,
    takeProfit: 17, stopLoss: 7, cooldown: 3,
  },
  large_cap: {
    highDistMax: 0.07, ma20SlopeMin: 0.01, volOverheat: 6.0,
    rsiOptimal: [45, 60], rsiForming: [40, 45],
    ret20dStrong: 0.08, ret20dMid: 0.05, ret20dWeak: 0.03,
    takeProfit: 10, stopLoss: 10, cooldown: 5,
  },
};

// ============================================================
// 1. XML íŒŒì„œ
// ============================================================
function parseXML(text) {
  text = text.replace(/encoding="EUC-KR"/i, 'encoding="UTF-8"');
  const parser = new DOMParser();
  const doc = parser.parseFromString(text, 'text/xml');
  const chartdata = doc.querySelector('chartdata');
  if (!chartdata) throw new Error('chartdata ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');

  const symbol = chartdata.getAttribute('symbol') || '';
  const name = chartdata.getAttribute('name') || symbol;
  const items = chartdata.querySelectorAll('item');
  const data = [];

  items.forEach(item => {
    const parts = item.getAttribute('data').split('|');
    if (parts.length === 6) {
      const ds = parts[0];
      data.push({
        date: ds.slice(0,4)+'-'+ds.slice(4,6)+'-'+ds.slice(6,8),
        open: +parts[1], high: +parts[2], low: +parts[3],
        close: +parts[4], volume: +parts[5],
      });
    }
  });

  data.sort((a,b) => a.date.localeCompare(b.date));
  return { symbol, name, data };
}

// ============================================================
// 2. ê¸°ìˆ ì§€í‘œ ê³„ì‚°
// ============================================================
function calcIndicators(data) {
  const n = data.length;
  const close = data.map(d=>d.close);

  // Moving Averages
  [5,20,60].forEach(w => {
    for (let i=0;i<n;i++) {
      if (i < w-1) { data[i]['ma'+w]=null; continue; }
      let sum=0; for(let j=i-w+1;j<=i;j++) sum+=close[j];
      data[i]['ma'+w] = sum/w;
    }
  });

  // RSI (Wilder)
  const rsi = new Array(n).fill(null);
  const period = 14;
  if (n > period) {
    let gains=[], losses=[];
    for (let i=1;i<=period;i++) {
      const d = close[i]-close[i-1];
      gains.push(d>0?d:0);
      losses.push(d<0?-d:0);
    }
    let avgGain = gains.reduce((a,b)=>a+b,0)/period;
    let avgLoss = losses.reduce((a,b)=>a+b,0)/period;
    rsi[period] = avgLoss===0?100:100-100/(1+avgGain/avgLoss);
    for (let i=period+1;i<n;i++) {
      const d = close[i]-close[i-1];
      avgGain = (avgGain*(period-1)+(d>0?d:0))/period;
      avgLoss = (avgLoss*(period-1)+(d<0?-d:0))/period;
      rsi[i] = avgLoss===0?100:100-100/(1+avgGain/avgLoss);
    }
  }
  data.forEach((d,i)=>d.rsi=rsi[i]);

  // Bollinger Bands
  for (let i=0;i<n;i++) {
    if (i<19) { data[i].bbMid=null;data[i].bbUpper=null;data[i].bbLower=null;continue; }
    let sum=0; for(let j=i-19;j<=i;j++) sum+=close[j];
    const mid = sum/20;
    let sq=0; for(let j=i-19;j<=i;j++) sq+=(close[j]-mid)**2;
    const std = Math.sqrt(sq/20);
    data[i].bbMid=mid; data[i].bbUpper=mid+2*std; data[i].bbLower=mid-2*std;
  }

  // Volume Ratio
  for (let i=0;i<n;i++) {
    if (i<19) { data[i].volRatio=null;data[i].volAvg=null;continue; }
    let sum=0; for(let j=i-19;j<=i;j++) sum+=data[j].volume;
    data[i].volAvg=sum/20;
    data[i].volRatio=data[i].volume/(sum/20);
  }

  // MACD
  const ema = (arr,span) => {
    const k=2/(span+1); const out=[arr[0]];
    for(let i=1;i<arr.length;i++) out.push(arr[i]*k+out[i-1]*(1-k));
    return out;
  };
  const ema12=ema(close,12), ema26=ema(close,26);
  const macdLine = ema12.map((v,i)=>v-ema26[i]);
  const macdSignal = ema(macdLine,9);
  data.forEach((d,i)=>{
    d.macd=macdLine[i]; d.macdSignal=macdSignal[i];
    d.macdHist=macdLine[i]-macdSignal[i];
  });

  // Candlestick patterns
  for (let i=1;i<n;i++) {
    const d=data[i], p=data[i-1];
    const body=d.close-d.open, bodyAbs=Math.abs(body);
    const upper=d.high-Math.max(d.open,d.close);
    const lower=Math.min(d.open,d.close)-d.low;
    d.isHammer = lower>2*bodyAbs && upper<bodyAbs*0.5 && bodyAbs>0;
    d.isBullishEngulfing = body>0 && (p.close-p.open)<0 && d.open<=p.close && d.close>=p.open;
  }
  data[0].isHammer=false; data[0].isBullishEngulfing=false;

  return data;
}

// ============================================================
// 3. ë²¤í¬ë“œ ë²•ì¹™
// ============================================================
const BENFORD = [0, .301, .176, .125, .097, .079, .067, .058, .051, .046];

function firstDigit(n) {
  n=Math.abs(n); if(n===0)return 0;
  while(n<1)n*=10; while(n>=10)n/=10;
  return Math.floor(n);
}

function benfordChi2(values) {
  const digits = values.filter(v=>v!==0).map(firstDigit).filter(d=>d>=1&&d<=9);
  if (digits.length<5) return 0;
  const observed = new Array(9).fill(0);
  digits.forEach(d=>observed[d-1]++);
  let chi2=0;
  for(let d=1;d<=9;d++){
    const exp=BENFORD[d]*digits.length;
    if(exp>0) chi2+=(observed[d-1]-exp)**2/exp;
  }
  return chi2;
}

function benfordScore(values) {
  const chi2 = benfordChi2(values);
  return { score: 1-1/(1+chi2/15), chi2 };
}

// ============================================================
// 4-A. ë²¤í¬ë“œ ì¼ë³„ ì´ìƒì ìˆ˜ ì‚¬ì „ê³„ì‚° (ì„±ëŠ¥ ìµœì í™”)
// ============================================================
function precomputeBenfordDailyScores(data, benfordWindow) {
  // ê° ì¼ë´‰ë§ˆë‹¤ ë²¤í¬ë“œ ì´ìƒ ì •ë„ë¥¼ ë¯¸ë¦¬ ê³„ì‚° â†’ ë°°ì—´ë¡œ ë°˜í™˜
  // score > 0.03 ì´ë©´ "ì´ìƒì¼"ë¡œ íŒì •
  const scores = new Array(data.length).fill(0);
  for (let idx = benfordWindow; idx < data.length; idx++) {
    const volSlice = [];
    for (let j = Math.max(0, idx - benfordWindow); j <= idx; j++) volSlice.push(data[j].volume);
    const vbs = benfordScore(volSlice);
    const priceSlice = [];
    for (let j = Math.max(0, idx - benfordWindow); j <= idx; j++) priceSlice.push(data[j].close);
    const changes = [];
    for (let j = 1; j < priceSlice.length; j++) changes.push(Math.abs(priceSlice[j] - priceSlice[j-1]));
    const pbs = benfordScore(changes.filter(c => c > 0));
    scores[idx] = (vbs.score + pbs.score) * 0.1; // 0.03 ì´ìƒì´ë©´ ì´ìƒ íŒì •
  }
  return scores;
}

// ============================================================
// 4-B. ì‹œê·¸ë„ ì—”ì§„ (v7 â€” ì„¸ë ¥ ëˆ„ì  ê°ì§€)
// ============================================================
function calcBuyScore(data, idx, profileName, benfordInfluence, benfordWindow, benfordMinHits, benfordDailyScores) {
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // ë°ì´í„° ê¸°ë°˜ ë§¤ìˆ˜ ìŠ¤ì½”ì–´ë§ v3
  // 3ì¢…ëª© 104ê°œ 10%+ ìƒìŠ¹ ì§ì „ íŒ¨í„´ ë¶„ì„ ê²°ê³¼:
  //   - ìƒìŠ¹ì˜ 64%ëŠ” RSI<50(ê³¼ë§¤ë„)ì—ì„œ ì‹œì‘
  //   - ìƒìŠ¹ì˜ 87%ëŠ” ì§ì „ 5ì¼ ìˆ˜ìµì´ ìŒ(-)
  //   - ìƒìŠ¹ì˜ 65%ëŠ” ì •ë°°ì—´ ì—†ì´ ì‹œì‘
  //   - ìƒìŠ¹ì˜ 71%ëŠ” ìŒë´‰ë‚  ì‹œì‘
  //   - í‰ê·  BBìœ„ì¹˜ 29%, í‰ê·  RSI 43.5
  // â†’ ì „ëµ: ê³¼ë§¤ë„ ë°˜ë“± + ì¶”ì„¸ ì¶”ì¢… ë“€ì–¼ ì—”ì§„
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  if (idx<60) return {score:0, details:{}};
  const row=data[idx], prev=data[idx-1];
  const details = {};
  const ma5=row.ma5, ma20=row.ma20, ma60=row.ma60;
  if (ma5==null||ma20==null||ma60==null) return {score:0,details:{}};

  // â”€â”€ ì ˆëŒ€ ì°¨ë‹¨ (ê·¹ë‹¨ ìƒí™©ë§Œ) â”€â”€
  if (row.volRatio!=null && row.volRatio>10) return {score:0,details:{}}; // ê·¹ë‹¨ ê³¼ì—´
  if (row.rsi!=null && row.rsi>85) return {score:0,details:{}}; // ê·¹ë‹¨ ê³¼ë§¤ìˆ˜

  let score = 0;

  // â•â•â•â•â•â• PATTERN A: ê³¼ë§¤ë„ ë°˜ë“± ë§¤ìˆ˜ (ë°ì´í„°: ìƒìŠ¹ì˜ 64%) â•â•â•â•â•â•
  // RSI ê³¼ë§¤ë„ ê°ì§€ (í‰ê·  ìƒìŠ¹ì‹œì‘ RSI=43.5)
  if (row.rsi!=null) {
    if (row.rsi<25) { score+=3.5; details['rsi']='ê·¹ê³¼ë§¤ë„('+row.rsi.toFixed(0)+')'; }
    else if (row.rsi<35) { score+=3; details['rsi']='ê³¼ë§¤ë„('+row.rsi.toFixed(0)+')'; }
    else if (row.rsi<45) { score+=2; details['rsi']='ì•½ê³¼ë§¤ë„('+row.rsi.toFixed(0)+')'; }
    else if (row.rsi<55) { score+=1; details['rsi']='ì¤‘ë¦½('+row.rsi.toFixed(0)+')'; }
    else if (row.rsi<65) { score+=0.5; details['rsi']='ëª¨ë©˜í…€('+row.rsi.toFixed(0)+')'; }
    else if (row.rsi<80) { details['rsi']='ê°•ì„¸('+row.rsi.toFixed(0)+')'; }
    else { score-=1; details['rsi']='ê³¼ë§¤ìˆ˜('+row.rsi.toFixed(0)+')'; }
  }

  // BB ìœ„ì¹˜ (í‰ê·  ìƒìŠ¹ì‹œì‘ BB=29%)
  if (row.bbMid!=null && row.bbUpper!=null && row.bbLower!=null) {
    const bbRange = row.bbUpper - row.bbLower;
    const bbPos = bbRange > 0 ? (row.close - row.bbLower) / bbRange : 0.5;
    if (bbPos<0.15) { score+=2.5; details['bb']='BBí•˜ë‹¨ëŒíŒŒ('+Math.round(bbPos*100)+'%)'; }
    else if (bbPos<0.30) { score+=2; details['bb']='BBí•˜ë‹¨('+Math.round(bbPos*100)+'%)'; }
    else if (bbPos<0.45) { score+=1; details['bb']='BBí•˜ìœ„('+Math.round(bbPos*100)+'%)'; }
    else if (bbPos>0.85) { score-=0.5; details['bb']='BBìƒë‹¨('+Math.round(bbPos*100)+'%)'; }
  }

  // ìµœê·¼ í•˜ë½ (í‰ê·  ìƒìŠ¹ ì§ì „ 5ì¼ìˆ˜ìµ = -4.9%)
  if (idx>=5) {
    const ret5 = (row.close - data[idx-5].close) / data[idx-5].close;
    if (ret5<-0.08) { score+=2.5; details['dip']='ê¸‰ë½ë°˜ë“±('+Math.round(ret5*100)+'%)'; }
    else if (ret5<-0.04) { score+=2; details['dip']='í•˜ë½ë°˜ë“±('+Math.round(ret5*100)+'%)'; }
    else if (ret5<-0.01) { score+=1; details['dip']='ì¡°ì •ë°˜ë“±('+Math.round(ret5*100)+'%)'; }
  }

  // ì—°ì†í•˜ë½ í›„ ì²« ì–‘ë´‰ (ê°•ë ¥í•œ ë°˜ì „ ì‹ í˜¸)
  let consecDown = 0;
  for (let lb=1; lb<10 && idx-lb>=0; lb++) {
    if (data[idx-lb].close < data[idx-lb].open) consecDown++; else break;
  }
  if (consecDown>=3 && row.close>row.open) {
    score += 2; details['reversal'] = consecDown+'ìŒë´‰í›„ì–‘ë´‰';
  } else if (consecDown>=2 && row.close>row.open) {
    score += 1.5; details['reversal'] = consecDown+'ìŒë´‰í›„ì–‘ë´‰';
  } else if (row.close>row.open && prev.close<prev.open) {
    score += 0.5; details['reversal'] = 'ë°˜ì „ì–‘ë´‰';
  }

  // 20ì¼ ì €ì  ê·¼ì ‘ (ë°”ë‹¥ í¬ì°©)
  let low20 = Infinity;
  for (let j=Math.max(0,idx-20);j<=idx;j++) if(data[j].low<low20) low20=data[j].low;
  if (low20<Infinity) {
    const distLow = (row.close - low20) / low20;
    if (distLow<0.02) { score+=1.5; details['low']='20ì¼ì €ì ê·¼ì ‘'; }
    else if (distLow<0.05) { score+=0.8; details['low']='ì €ì ë¶€ê·¼'; }
  }

  // MA20 ëŒ€ë¹„ ì´ê²© (í‰ê· íšŒê·€)
  const gapMA20 = (row.close - ma20) / ma20;
  if (gapMA20<-0.08) { score+=1.5; details['mean']='MA20-8%ì´ê²©'; }
  else if (gapMA20<-0.04) { score+=1; details['mean']='MA20-4%ì´ê²©'; }

  // â•â•â•â•â•â• PATTERN B: ì¶”ì„¸ ì¶”ì¢… ë§¤ìˆ˜ (ë°ì´í„°: ìƒìŠ¹ì˜ 35%) â•â•â•â•â•â•
  if (ma5>ma20 && ma20>ma60) { score+=2; details['align']='ì •ë°°ì—´'; }
  else if (ma5>ma20) { score+=0.8; details['align']='ë‹¨ê¸°ì •ë ¬'; }

  // MA20 ê¸°ìš¸ê¸°
  if (idx>=10) {
    const ma20_10 = data[idx-10].ma20;
    if (ma20_10!=null && ma20_10>0) {
      const slope = (ma20-ma20_10)/ma20_10;
      if (slope>0.03) { score+=1.5; details['slope']='MA20ê¸‰ë“±â†‘'; }
      else if (slope>0.01) { score+=1; details['slope']='MA20â†‘'; }
      else if (slope>0) { score+=0.3; }
    }
  }

  // 20ì¼ ê³ ì  ê·¼ì ‘
  let high20=0;
  for (let j=Math.max(0,idx-20);j<=idx;j++) if(data[j].high>high20) high20=data[j].high;
  if (high20>0 && (high20-row.close)/high20<0.03) {
    score+=1; details['high']='ì‹ ê³ ê°€ê·¼ì ‘';
  }

  // â•â•â•â•â•â• ê³µí†µ ì‹œê·¸ë„ â•â•â•â•â•â•
  // MACD
  if (row.macdHist!=null && row.macdHist>0) {
    score+=0.8;
    if (prev.macdHist!=null && prev.macdHist<=0) { score+=1.5; details['macd']='MACDê³¨ë“ í¬ë¡œìŠ¤'; }
    else if (prev.macdHist!=null && row.macdHist>prev.macdHist) { score+=0.3; details['macd']='MACDê°€ì†'; }
    else { details['macd']='MACDì–‘ì „'; }
  }

  // ê±°ë˜ëŸ‰ (ì •ìƒ~ì•½ê°„ ë†’ìŒì´ ì´ìƒì , í‰ê·  1.06x)
  if (row.volRatio!=null) {
    if (row.volRatio>=1.2 && row.volRatio<=3) { score+=1; details['vol']='ê±°ë˜ëŸ‰(x'+row.volRatio.toFixed(1)+')'; }
    else if (row.volRatio>3 && row.volRatio<=6) { score+=0.3; details['vol']='ë†’ì€ê±°ë˜ëŸ‰'; }
    else if (row.volRatio>6) { score-=0.5; details['vol']='ê³¼ì—´ì£¼ì˜'; }
  }

  // ì–‘ë´‰
  if (row.close>row.open) score+=0.5;

  // ìƒìŠ¹ì¥ì•…í˜• ìº”ë“¤
  if (row.isBullishEngulfing) { score+=1; details['candle']='ìƒìŠ¹ì¥ì•…í˜•'; }

  // â•â•â•â•â•â• ë¦¬ìŠ¤í¬ ê°ì  â•â•â•â•â•â•
  // 5ì¼ ê¸‰ë“± í›„ (ì´ë¯¸ ë§ì´ ì˜¬ëìœ¼ë©´ ê°ì )
  if (idx>=5) {
    const ret5 = (row.close - data[idx-5].close) / data[idx-5].close;
    if (ret5>0.15) { score-=1.5; details['risk']='5ì¼ê¸‰ë“±ì£¼ì˜'; }
  }

  // â•â•â•â•â•â• ë²¤í¬ë“œ ì„¸ë ¥ ê°ì§€ â•â•â•â•â•â•
  const maxInfluence = (benfordInfluence || 15) / 100;
  const bw = benfordWindow || 30;
  const minHits = benfordMinHits || 3;
  let bmult = 1.0;

  if (maxInfluence > 0 && benfordDailyScores) {
    let hitCount = 0, totalStr = 0;
    for (let d = 0; d < bw && (idx - d) >= 0; d++) {
      const ds = benfordDailyScores[idx - d];
      if (ds > 0.03) { hitCount++; totalStr += ds; }
    }
    if (hitCount >= minHits) {
      const hr = hitCount / bw;
      const as = totalStr / hitCount;
      bmult = 1 + Math.min(hr * as * 5, maxInfluence);
      if (hitCount >= minHits * 2) bmult *= 1.05;
      details['benford'] = 'ì„¸ë ¥'+hitCount+'/'+bw+'ì¼(x'+bmult.toFixed(2)+')';
    }
  }

  return { score: score * bmult, details };
}

// ============================================================
// 5. ë°±í…ŒìŠ¤í„°
// ============================================================
function runBacktest(data, params) {
  const { takeProfit, stopLoss, cooldown, benfordWindow, profileName, benfordInfluence, startIdx, benfordMinHits, _benfordDailyScores, commissionRate, taxRate, quantity } = params;
  const trades = [];
  let lastBuyIdx = -cooldown;
  const beginIdx = Math.max(60, startIdx || 60);
  const comm = (commissionRate || 0) / 100; // ë§¤ìˆ˜/ë§¤ë„ ìˆ˜ìˆ˜ë£Œìœ¨ (ì˜ˆ: 0.015% â†’ 0.00015)
  const tax = (taxRate || 0) / 100; // ë§¤ë„ ì„¸ê¸ˆìœ¨ (ì˜ˆ: 0.18% â†’ 0.0018)
  const qty = quantity || 10; // ê±°ë˜ ìˆ˜ëŸ‰ (ê¸°ë³¸ 10ì£¼)

  // ë²¤í¬ë“œ ì¼ë³„ ì ìˆ˜ ì‚¬ì „ê³„ì‚° (ì™¸ë¶€ì—ì„œ ì „ë‹¬ë°›ê±°ë‚˜ ì§ì ‘ ê³„ì‚°)
  const maxInfl = (benfordInfluence || 15) / 100;
  const benfordDailyScores = _benfordDailyScores || (maxInfl > 0 ? precomputeBenfordDailyScores(data, benfordWindow) : null);

  for (let idx=beginIdx; idx<data.length; idx++) {
    if (idx-lastBuyIdx < cooldown) continue;
    const { score, details } = calcBuyScore(data, idx, profileName, benfordInfluence, benfordWindow, benfordMinHits, benfordDailyScores);
    if (score < 5.0) continue;

    const entry = data[idx];
    const entryPrice = entry.close;
    const targetPrice = entryPrice * (1 + takeProfit);
    const stopPrice = entryPrice * (1 - stopLoss);

    let result = null, exitIdx = null, exitPrice = null, exitReason = '';

    for (let j = idx + 1; j < data.length; j++) {
      const day = data[j];

      const hitStop = day.low <= stopPrice;
      const hitTarget = day.high >= targetPrice;

      if (hitTarget && hitStop) {
        // ê°™ì€ ë‚  ë‘ ê°€ê²© ëª¨ë‘ ë„ë‹¬ â†’ ì‹œê°€ ê¸°ì¤€ íŒë‹¨
        if (day.open <= stopPrice) {
          result = 'LOSS'; exitPrice = stopPrice; exitReason = 'ì†ì ˆ';
        } else if (day.open >= targetPrice) {
          result = 'WIN'; exitPrice = targetPrice; exitReason = 'ìµì ˆ';
        } else {
          // ë³´ìˆ˜ì  íŒë‹¨: ì†ì ˆ ìš°ì„ 
          result = 'LOSS'; exitPrice = stopPrice; exitReason = 'ì†ì ˆ';
        }
        exitIdx = j;
        break;
      } else if (hitTarget) {
        result = 'WIN'; exitPrice = targetPrice; exitIdx = j; exitReason = 'ìµì ˆ';
        break;
      } else if (hitStop) {
        result = 'LOSS'; exitPrice = stopPrice; exitIdx = j; exitReason = 'ì†ì ˆ';
        break;
      }
    }

    if (!result) { result = 'OPEN'; exitIdx = data.length - 1; exitPrice = data[data.length - 1].close; exitReason = 'ì§„í–‰ì¤‘'; }

    const holdDays = Math.round((new Date(data[exitIdx].date) - new Date(entry.date)) / 86400000);
    // ìˆ˜ìˆ˜ë£Œ ë°˜ì˜ ìˆ˜ìµë¥ : ë§¤ìˆ˜ë¹„ìš© = ë§¤ìˆ˜ê°€Ã—(1+ìˆ˜ìˆ˜ë£Œ), ë§¤ë„ìˆ˜ì… = ë§¤ë„ê°€Ã—(1-ìˆ˜ìˆ˜ë£Œ-ì„¸ê¸ˆ)
    const buyCost = entryPrice * (1 + comm);
    const sellRevenue = exitPrice * (1 - comm - tax);
    const retPct = (sellRevenue - buyCost) / buyCost * 100;
    // ìˆ˜ìˆ˜ë£Œ ë°˜ì˜ëœ WIN/LOSS ì¬íŒì •
    if (result !== 'OPEN') result = retPct >= 0 ? 'WIN' : 'LOSS';

    // ë§¤ë„ ê·¼ê±°ì— ì¶”ê°€ ì •ë³´
    const exitDetails = { ...details };
    exitDetails['exit'] = exitReason;

    trades.push({
      entryIdx: idx, exitIdx, entryDate: entry.date, exitDate: data[exitIdx].date,
      entryPrice: entryPrice, exitPrice: Math.round(exitPrice),
      targetPrice: Math.round(targetPrice), stopPrice: Math.round(stopPrice),
      score: Math.round(score * 10) / 10, details: exitDetails, result,
      returnPct: Math.round(retPct * 100) / 100, holdingDays: holdDays,
      exitReason, quantity: qty,
    });
    lastBuyIdx = idx;
  }
  return trades;
}

function summarize(trades) {
  const wins=trades.filter(t=>t.result==='WIN');
  const losses=trades.filter(t=>t.result==='LOSS');
  const opens=trades.filter(t=>t.result==='OPEN');
  const closed=[...wins,...losses];
  const winRate = closed.length?wins.length/closed.length*100:0;
  const avgRet = closed.length?closed.reduce((s,t)=>s+t.returnPct,0)/closed.length:0;
  let cumRet=1; closed.sort((a,b)=>a.entryDate.localeCompare(b.entryDate)).forEach(t=>cumRet*=(1+t.returnPct/100));
  const avgHold = closed.length?closed.reduce((s,t)=>s+t.holdingDays,0)/closed.length:0;

  // ê±°ë˜ ìˆ˜ëŸ‰ ë°˜ì˜ ìˆ˜ìµê¸ˆ ê³„ì‚° (ìˆ˜ìˆ˜ë£Œ ë°˜ì˜: returnPctì— ì´ë¯¸ í¬í•¨)
  let totalProfit = 0;
  let totalInvested = 0;
  closed.sort((a,b)=>a.entryDate.localeCompare(b.entryDate)).forEach(t => {
    const qty = t.quantity || 10;
    t._shares = qty;
    t._invested = t.entryPrice * qty;
    t._profit = Math.round(t.entryPrice * qty * t.returnPct / 100);
    totalProfit += t._profit;
    totalInvested += t._invested;
  });
  opens.forEach(t => {
    const qty = t.quantity || 10;
    t._shares = qty;
    t._invested = t.entryPrice * qty;
    t._profit = Math.round(t.entryPrice * qty * t.returnPct / 100);
  });

  return {
    total:trades.length, wins:wins.length, losses:losses.length, opens:opens.length,
    closed:closed.length, winRate:Math.round(winRate*10)/10,
    avgReturn:Math.round(avgRet*100)/100,
    cumReturn:Math.round((cumRet-1)*10000)/100,
    avgHolding:Math.round(avgHold),
    totalProfit, totalInvested,
    avgProfit: closed.length ? Math.round(totalProfit / closed.length) : 0,
    compoundProfit: closed.length ? Math.round((totalInvested / closed.length) * (cumRet - 1)) : 0,
  };
}

// ============================================================
// 6. ì°¨íŠ¸ ë Œë”ë§ (UX ê°œì„ : ë§ˆì»¤ í† ê¸€ + ê±°ë˜ ì¤Œ)
// ============================================================
let mainChart=null, volChart=null, candleSeries=null;
let currentData=null, currentTrades=null, selectedTradeIdx=null;

function renderChart(data, trades) {
  currentData = data;
  currentTrades = trades;
  selectedTradeIdx = null;

  const cc=document.getElementById('chartContainer');
  const vc=document.getElementById('volumeContainer');
  cc.innerHTML=''; vc.innerHTML='';

  // Main chart
  mainChart = LightweightCharts.createChart(cc, {
    width:cc.clientWidth, height:480,
    layout:{background:{color:'#1a1a2e'},textColor:'#d1d4dc'},
    grid:{vertLines:{color:'#252540'},horzLines:{color:'#252540'}},
    crosshair:{mode:LightweightCharts.CrosshairMode.Normal},
    rightPriceScale:{borderColor:'#252540'},
    timeScale:{borderColor:'#252540',timeVisible:false},
  });

  // Candlestick
  candleSeries = mainChart.addCandlestickSeries({
    upColor:'#ef5350', downColor:'#26a69a',
    borderUpColor:'#ef5350', borderDownColor:'#26a69a',
    wickUpColor:'#ef5350', wickDownColor:'#26a69a',
  });
  candleSeries.setData(data.map(d=>({time:d.date,open:d.open,high:d.high,low:d.low,close:d.close})));

  // MA lines
  const addMA=(key,color)=>{
    const s=mainChart.addLineSeries({color,lineWidth:1,priceLineVisible:false,lastValueVisible:false});
    s.setData(data.filter(d=>d[key]!=null).map(d=>({time:d.date,value:d[key]})));
  };
  addMA('ma5','#f5c842');
  addMA('ma20','#2196f3');
  addMA('ma60','#e040fb');

  // ì´ˆê¸°: ë§ˆì»¤ ì—†ì´ ê¹”ë”í•œ ì°¨íŠ¸
  candleSeries.setMarkers([]);

  // Volume chart
  volChart = LightweightCharts.createChart(vc, {
    width:vc.clientWidth, height:120,
    layout:{background:{color:'#1a1a2e'},textColor:'#d1d4dc'},
    grid:{vertLines:{color:'#252540'},horzLines:{color:'#252540'}},
    rightPriceScale:{borderColor:'#252540'},
    timeScale:{borderColor:'#252540',timeVisible:false,visible:true},
  });

  const vs = volChart.addHistogramSeries({
    priceFormat:{type:'volume'},
    priceLineVisible:false, lastValueVisible:false,
  });
  vs.setData(data.map(d=>({
    time:d.date, value:d.volume,
    color: d.close>=d.open?'rgba(239,83,80,0.4)':'rgba(38,166,154,0.4)',
  })));

  // Sync time scales
  mainChart.timeScale().subscribeVisibleLogicalRangeChange(range=>{
    if(range) volChart.timeScale().setVisibleLogicalRange(range);
  });
  volChart.timeScale().subscribeVisibleLogicalRangeChange(range=>{
    if(range) mainChart.timeScale().setVisibleLogicalRange(range);
  });

  // Resize
  const resize=()=>{
    mainChart.applyOptions({width:cc.clientWidth});
    volChart.applyOptions({width:vc.clientWidth});
  };
  window.addEventListener('resize',resize);
}

function buildMarkers(tradeIndices) {
  // tradeIndices: í‘œì‹œí•  ê±°ë˜ ì¸ë±ìŠ¤ ë°°ì—´ (nullì´ë©´ ì „ì²´)
  const trades = currentTrades;
  if (!trades) return [];
  const indices = tradeIndices || trades.map((_,i)=>i);
  const markers = [];
  indices.forEach(i => {
    const t = trades[i];
    if (!t) return;
    markers.push({
      time: t.entryDate,
      position: 'belowBar',
      color: '#ffeb3b',
      shape: 'arrowUp',
      text: `#${i+1} ë§¤ìˆ˜ ${t.score}ì `,
    });
    markers.push({
      time: t.exitDate,
      position: 'aboveBar',
      color: t.result==='WIN'?'#ff5252':t.result==='LOSS'?'#26a69a':'#ffc107',
      shape: 'arrowDown',
      text: t.result==='WIN'?`#${i+1} ìµì ˆ+${t.returnPct.toFixed(0)}%`
           :t.result==='LOSS'?`#${i+1} ì†ì ˆ${t.returnPct.toFixed(0)}%`
           :`#${i+1} ì§„í–‰ì¤‘`,
    });
  });
  markers.sort((a,b)=>a.time.localeCompare(b.time));
  return markers;
}

function showAllMarkers() {
  if (!candleSeries || !currentTrades) return;
  candleSeries.setMarkers(buildMarkers(null));
  document.getElementById('btnShowAll').classList.add('active');
}

function clearMarkers() {
  if (!candleSeries) return;
  candleSeries.setMarkers([]);
  selectedTradeIdx = null;
  document.getElementById('btnShowAll').classList.remove('active');
  // ì„ íƒ í•´ì œ
  document.querySelectorAll('.trade-selected').forEach(el=>el.classList.remove('trade-selected'));
  // ì „ì²´ ë²”ìœ„ë¡œ ë¦¬ì…‹
  if (mainChart) mainChart.timeScale().fitContent();
}

function zoomToTrade(idx) {
  if (!currentTrades || !currentData || !mainChart) return;
  const t = currentTrades[idx];
  if (!t) return;

  // ë§¤ìˆ˜ì¼ -30ì¼ ~ ë§¤ë„ì¼ +15ì¼
  const entryDataIdx = t.entryIdx;
  const exitDataIdx = t.exitIdx;
  const fromIdx = Math.max(0, entryDataIdx - 30);
  const toIdx = Math.min(currentData.length - 1, exitDataIdx + 15);

  const fromDate = currentData[fromIdx].date;
  const toDate = currentData[toIdx].date;

  mainChart.timeScale().setVisibleRange({
    from: fromDate,
    to: toDate,
  });
}

function handleTradeRowClick(idx) {
  const rows = document.querySelectorAll('#tradeBody tr');

  if (selectedTradeIdx === idx) {
    // ì¬í´ë¦­: í•´ì œ
    clearMarkers();
    return;
  }

  // ê¸°ì¡´ ì„ íƒ í•´ì œ
  rows.forEach(r => r.classList.remove('trade-selected'));
  document.getElementById('btnShowAll').classList.remove('active');

  // ìƒˆ ì„ íƒ
  selectedTradeIdx = idx;
  if (rows[idx]) rows[idx].classList.add('trade-selected');

  // í•´ë‹¹ ê±°ë˜ ë§ˆì»¤ë§Œ í‘œì‹œ
  candleSeries.setMarkers(buildMarkers([idx]));

  // ì°¨íŠ¸ ì¤Œ
  zoomToTrade(idx);
}

// ============================================================
// 7. UI ë Œë”ë§
// ============================================================
function renderStats(summary, stockInfo) {
  let infoHtml = `<strong>${stockInfo.name}</strong> (${stockInfo.symbol}) &nbsp;|&nbsp; ` +
    `${stockInfo.data[0].date} ~ ${stockInfo.data[stockInfo.data.length-1].date} &nbsp;|&nbsp; ` +
    `${stockInfo.data.length.toLocaleString()}ê±°ë˜ì¼`;
  if (summary.rangeLabel && summary.rangeLabel !== 'ì „ì²´ ê¸°ê°„') {
    infoHtml += `<br><span style="color:#f5c842; font-size:13px;">ë¶„ì„ êµ¬ê°„: ${summary.rangeLabel}</span>`;
  }
  document.getElementById('stockInfo').innerHTML = infoHtml;

  const grid = document.getElementById('statsGrid');
  const fmtWon = (v) => {
    const abs = Math.abs(v);
    if (abs >= 100000000) return (v/100000000).toFixed(1)+'ì–µì›';
    if (abs >= 10000) return Math.round(v/10000).toLocaleString()+'ë§Œì›';
    return v.toLocaleString()+'ì›';
  };
  const items = [
    {label:'ì´ ì‹œê·¸ë„', value:summary.total+'ê±´'},
    {label:'ìŠ¹ë¦¬', value:summary.wins+'ê±´', cls:'win'},
    {label:'íŒ¨ë°°', value:summary.losses+'ê±´', cls:'loss'},
    {label:'ìŠ¹ë¥ ', value:summary.winRate+'%'},
    {label:'í‰ê·  ìˆ˜ìµë¥ ', value:(summary.avgReturn>=0?'+':'')+summary.avgReturn+'%',
     cls:summary.avgReturn>=0?'text-green':'text-red', hl:true},
    {label:'ì´ ìˆ˜ìµê¸ˆ', value:(summary.totalProfit>=0?'+':'')+fmtWon(summary.totalProfit),
     cls:summary.totalProfit>=0?'text-green':'text-red', hl:true,
     tip:'ì‹œê·¸ë„ë‹¹ ì„¤ì • ìˆ˜ëŸ‰ë§Œí¼ ë§¤ë§¤í–ˆì„ ë•Œ ëª¨ë“  ì™„ë£Œ ê±°ë˜ì˜ ìˆ˜ìµê¸ˆ í•©ê³„'},
    {label:'ë§¤ìˆ˜ ì´ì•¡', value:fmtWon(summary.totalInvested),
     tip:'ëª¨ë“  ë§¤ìˆ˜ ì‹œê·¸ë„ì—ì„œ íˆ¬ìí•œ ê¸ˆì•¡ì˜ í•©ê³„ (ë§¤ìˆ˜ê°€ Ã— ìˆ˜ëŸ‰)'},
    {label:'ì”ì—¬ ì´ì•¡', value:fmtWon(summary.totalInvested + summary.totalProfit),
     cls:(summary.totalInvested + summary.totalProfit) >= summary.totalInvested ? 'text-green' : 'text-red',
     tip:'ë§¤ìˆ˜ ì´ì•¡ + ì´ ìˆ˜ìµê¸ˆ. ì‹¤ì œë¡œ ì†ì— ë‚¨ëŠ” ê¸ˆì•¡'},
    {label:'í‰ê·  ë³´ìœ ê¸°ê°„', value:summary.avgHolding+'ì¼', span:2},
    {label:'ìˆ˜ìµê¸ˆ ì¬íˆ¬ìì‹œ ìˆ˜ìµë¥ ', value:(summary.cumReturn>=0?'+':'')+summary.cumReturn+'%',
     cls:summary.cumReturn>=0?'text-green':'text-red',
     tip:'ê° ê±°ë˜ì˜ ìˆ˜ìµì„ ë‹¤ìŒ ê±°ë˜ì— ì¬íˆ¬ìí–ˆì„ ë•Œì˜ ëˆ„ì  ë³µë¦¬ ìˆ˜ìµë¥ '},
    {label:'ìˆ˜ìµê¸ˆ ì¬íˆ¬ìì‹œ ì´ ìˆ˜ìµê¸ˆ', value:(summary.compoundProfit>=0?'+':'')+fmtWon(summary.compoundProfit),
     cls:summary.compoundProfit>=0?'text-green':'text-red',
     tip:'ê±°ë˜ë‹¹ í‰ê·  íˆ¬ìê¸ˆì„ ê¸°ì¤€ìœ¼ë¡œ ë³µë¦¬ ì¬íˆ¬ìí–ˆì„ ë•Œì˜ ì´ ìˆ˜ìµê¸ˆ'},
  ];
  grid.innerHTML = items.map(it=>{
    const cls = it.hl?'stat-box highlight':'stat-box';
    const spanStyle = it.span ? `grid-column:span ${it.span};` : '';
    const tipHtml = it.tip ? `<span class="tooltip-wrap" style="position:absolute;top:8px;right:8px;"><span class="tooltip-icon" style="font-size:10px;width:14px;height:14px;">?</span><span class="tooltip-content" style="width:280px;right:0;left:auto;transform:none;">${it.tip}</span></span>` : '';
    return `<div class="${cls}" style="position:relative;${spanStyle}">${tipHtml}<div class="label">${it.label}</div><div class="value ${it.cls||''}">${it.value}</div></div>`;
  }).join('');
}

function renderTrades(trades) {
  const body = document.getElementById('tradeBody');
  const fmtWon = (v) => {
    const abs = Math.abs(v);
    if (abs >= 100000000) return (v/100000000).toFixed(1)+'ì–µ';
    if (abs >= 10000) return (v>=0?'+':'')+Math.round(v/10000).toLocaleString()+'ë§Œ';
    return (v>=0?'+':'')+v.toLocaleString()+'ì›';
  };
  body.innerHTML = trades.map((t,i)=>{
    const badge = t.result==='WIN'?'badge-win':t.result==='LOSS'?'badge-loss':'badge-open';
    const label = t.result==='WIN'?'ìŠ¹':t.result==='LOSS'?'íŒ¨':'ì§„í–‰';
    const retCls = t.returnPct>=0?'text-green':'text-red';
    const profitCls = (t._profit||0)>=0?'text-green':'text-red';
    const reasons = Object.values(t.details).join(', ');
    const profit = t._profit || 0;
    const exitReasonCls = t.exitReason && t.exitReason.includes('ìµì ˆ') ? 'text-green' : t.exitReason && t.exitReason.includes('ì†ì ˆ') ? 'text-red' : '';
    const maxGainInfo = t.details && t.details.maxGain ? ` (${t.details.maxGain})` : '';
    const qty = t._shares || t.quantity || 10;
    const invested = t._invested || (t.entryPrice * qty);
    const fmtInvested = invested >= 100000000 ? (invested/100000000).toFixed(1)+'ì–µ' : invested >= 10000 ? Math.round(invested/10000).toLocaleString()+'ë§Œ' : invested.toLocaleString()+'ì›';
    return `<tr data-trade-idx="${i}" onclick="handleTradeRowClick(${i})">
      <td>${i+1}</td>
      <td><span class="badge ${badge}">${label}</span></td>
      <td>${t.entryDate}</td>
      <td>${t.entryPrice.toLocaleString()}ì›</td>
      <td>${qty}ì£¼</td>
      <td>${fmtInvested}</td>
      <td>${t.exitDate}</td>
      <td>${t.exitPrice.toLocaleString()}ì›</td>
      <td class="${retCls}">${t.returnPct>=0?'+':''}${t.returnPct}%</td>
      <td class="${profitCls}" style="font-weight:600">${fmtWon(profit)}</td>
      <td>${t.holdingDays}ì¼</td>
      <td class="${exitReasonCls}" style="font-size:11px;">${t.exitReason||'-'}${maxGainInfo}</td>
      <td>${t.score}</td>
      <td class="reason-cell"><span class="trade-reason-tip"><span class="tip-icon">â„¹</span><span class="tip-pop">${reasons}</span></span></td>
      <td class="spacer-td"></td>
    </tr>`;
  }).join('');
}

// ============================================================
// 8. ëª¨ë“œ ì „í™˜ & ìë™ ì¶”ì²œ
// ============================================================
let currentMode = 'auto'; // 'manual' or 'auto'

function setMode(mode) {
  currentMode = mode;
  document.getElementById('modeManual').classList.toggle('active', mode==='manual');
  document.getElementById('modeAuto').classList.toggle('active', mode==='auto');
  document.getElementById('autoInfo').style.display = mode==='auto' ? 'block' : 'none';

  // ìë™ëª¨ë“œ ì „í™˜ + ì´ë¯¸ ë°ì´í„° ë¡œë“œë¨ â†’ ì¦‰ì‹œ ìµœì í™” ì‹¤í–‰
  if (mode === 'auto' && stockData) {
    document.getElementById('recommendBanner').innerHTML =
      `<div class="rec-title rec-title-loading">ìë™ ìµœì í™” ì§„í–‰ ì¤‘...</div><div class="rec-detail" style="color:#888;">6ê°œ íŒŒë¼ë¯¸í„° ì¡°í•© íƒìƒ‰ ì¤‘ì…ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.</div>`;
    document.getElementById('recommendBanner').classList.add('active');
    document.getElementById('globalOptToast').classList.add('active');
    setTimeout(() => {
      try {
        const detection = autoDetectProfile(stockData.data);
        const si = getAnalysisStartIdx(stockData.data.length);
        const optResult = autoOptimize(stockData.data, detection.profileName, si);
        if (optResult) {
          applyBestStrategy(detection.profileName, optResult);
        }
        showRecommendBanner(detection, optResult);
      } catch(err) {
        console.error('ìë™ ìµœì í™” ì˜¤ë¥˜:', err);
        const detection = autoDetectProfile(stockData.data);
        showRecommendBanner(detection, null);
      }
    }, 30);
  } else if (mode === 'manual' && stockData) {
    // ìˆ˜ë™ëª¨ë“œë¡œ ì „í™˜ ì‹œ í”„ë¡œí•„ ê¸°ë³¸ê°’ ë³µì›
    const detection = autoDetectProfile(stockData.data);
    const profile = STOCK_PROFILES[detection.profileName];
    applyRecommendation(detection.profileName, profile.takeProfit/100, profile.stopLoss/100, profile.cooldown, 30, 15, 3);
    showRecommendBanner(detection, null);
  }
}

function analyzeVolatility(data) {
  // ì¼ê°„ ìˆ˜ìµë¥ ì˜ í‘œì¤€í¸ì°¨ë¡œ ë³€ë™ì„± ì¸¡ì •
  const returns = [];
  for (let i=1; i<data.length; i++) {
    returns.push(Math.abs(data[i].close - data[i-1].close) / data[i-1].close);
  }
  const avg = returns.reduce((a,b)=>a+b,0) / returns.length;
  const variance = returns.reduce((a,r)=>a+(r-avg)**2, 0) / returns.length;
  const stdDev = Math.sqrt(variance);

  // í‰ê·  ê°€ê²©ëŒ€
  const avgPrice = data.reduce((a,d)=>a+d.close, 0) / data.length;

  // 20ì¼ ATR (Average True Range)
  let atrSum = 0, atrCount = 0;
  for (let i=1; i<data.length; i++) {
    const tr = Math.max(
      data[i].high - data[i].low,
      Math.abs(data[i].high - data[i-1].close),
      Math.abs(data[i].low - data[i-1].close)
    );
    atrSum += tr / data[i-1].close; // % ê¸°ì¤€
    atrCount++;
  }
  const avgATR = atrSum / atrCount;

  return { avgReturn: avg, stdDev, avgPrice, avgATR };
}

function autoDetectProfile(data) {
  const vol = analyzeVolatility(data);
  // ëŒ€í˜•ì£¼ íŒë³„: ë‚®ì€ ë³€ë™ì„± + ë†’ì€ ê°€ê²©ëŒ€
  // ì¼í‰ê·  ATRì´ 2.5% ë¯¸ë§Œì´ë©´ ëŒ€í˜•ì£¼ë¡œ íŒë³„
  const isLargeCap = vol.avgATR < 0.025;
  return {
    profileName: isLargeCap ? 'large_cap' : 'default',
    isLargeCap,
    volatility: vol,
  };
}

function getAnalysisStartIdx(dataLen) {
  const rangeVal = parseInt(document.getElementById('analysisRange').value) || 0;
  if (rangeVal > 0 && rangeVal < dataLen) return Math.max(60, dataLen - rangeVal);
  return 60;
}

function autoOptimize(data, profileName, rangeStartIdx) {
  const idata = calcIndicators(JSON.parse(JSON.stringify(data)));
  const totalLen = idata.length;
  const commRate = parseFloat(document.getElementById('commissionRate').value) || 0;
  const taxR = parseFloat(document.getElementById('taxRate').value) || 0;

  // â”€â”€ ì›Œí¬í¬ì›Œë“œ: í›ˆë ¨ êµ¬ê°„ / í…ŒìŠ¤íŠ¸ êµ¬ê°„ ë¶„ë¦¬ â”€â”€
  // í•­ìƒ ìµœê·¼ 120ê±°ë˜ì¼(6ê°œì›”)ì„ í…ŒìŠ¤íŠ¸ êµ¬ê°„ìœ¼ë¡œ ì‚¬ìš©
  // â†’ íŒŒë¼ë¯¸í„° ê²€ì¦ + íˆ¬ì ë§¤ë ¥ë„ + ì¶”ì²œ ì „ëµ ëª¨ë‘ ë™ì¼ ê¸°ê°„
  const WF_TEST_DAYS = 120;
  let trainEnd, testStart;
  testStart = Math.max(60, totalLen - WF_TEST_DAYS);
  trainEnd = testStart;
  const trainStartIdx = 60; // ê¸°ìˆ ì§€í‘œ ìµœì†Œ 60ì¼ í•„ìš”

  // ì°¨íŠ¸ ë³€ë™ì„± ê¸°ë°˜ìœ¼ë¡œ íƒìƒ‰ ë²”ìœ„ë¥¼ ë™ì ìœ¼ë¡œ ê²°ì •
  const vol = analyzeVolatility(data);
  const dailyVol = vol.avgATR * 100; // % ë‹¨ìœ„

  // ë³€ë™ì„±ì— ë”°ë¼ íƒìƒ‰ ë²”ìœ„ ì„¸ë¶„í™” (ìŠ¹ë¥  80%+ ëª©í‘œ: ë‚®ì€ ìµì ˆ í¬í•¨)
  let tpRange, slRange, volLabel;
  if (dailyVol < 1.5) {
    volLabel = 'ì´ˆì €ë³€ë™(ì¼í‰ê· <1.5%)';
    tpRange = [0.02, 0.03, 0.04, 0.06, 0.08, 0.10];
    slRange = [0.03, 0.05, 0.07, 0.10];
  } else if (dailyVol < 2.5) {
    volLabel = 'ì €ë³€ë™(ì¼í‰ê· <2.5%)';
    tpRange = [0.03, 0.04, 0.06, 0.08, 0.10, 0.13];
    slRange = [0.04, 0.06, 0.08, 0.10];
  } else if (dailyVol < 4.0) {
    volLabel = 'ì¤‘ë³€ë™(ì¼í‰ê· <4%)';
    tpRange = [0.04, 0.06, 0.08, 0.10, 0.15, 0.21];
    slRange = [0.05, 0.07, 0.10, 0.13];
  } else {
    volLabel = 'ê³ ë³€ë™(ì¼í‰ê· â‰¥4%)';
    tpRange = [0.05, 0.08, 0.10, 0.15, 0.21, 0.30];
    slRange = [0.07, 0.10, 0.13, 0.15];
  }
  const cdRange = [2, 3, 5, 7];
  const bwRange = [15, 20, 30, 45];
  const biRange = [5, 10, 15, 20, 25];
  const bmhRange = [2, 3, 5]; // ì„¸ë ¥ ìµœì†Œ ê°ì§€íšŸìˆ˜

  let best = null;
  let bestProfit = null;
  let totalCombos = 0;
  let validCombos = 0;

  // â”€â”€ STEP1: í›ˆë ¨ êµ¬ê°„ì—ì„œ ìµœì  íŒŒë¼ë¯¸í„° íƒìƒ‰ â”€â”€
  const trainData = idata.slice(0, trainEnd);

  // ë²¤í¬ë“œ ì¼ë³„ì ìˆ˜ ì‚¬ì „ê³„ì‚° ìºì‹œ (bwë³„ 1íšŒë§Œ ê³„ì‚° â†’ ëŒ€ê·œëª¨ ì„±ëŠ¥ ê°œì„ )
  const benfordCache = {};
  for (const bw of bwRange) {
    benfordCache[bw] = precomputeBenfordDailyScores(trainData, bw);
  }

  for (const tp of tpRange) {
    for (const sl of slRange) {
      for (const cd of cdRange) {
        for (const bw of bwRange) {
          for (const bi of biRange) {
            for (const bmh of bmhRange) {
              totalCombos++;
              const trades = runBacktest(trainData, {
                takeProfit:tp, stopLoss:sl, cooldown:cd,
                benfordWindow:bw, profileName, benfordInfluence:bi,
                startIdx: trainStartIdx,
                benfordMinHits:bmh,
                _benfordDailyScores: benfordCache[bw],
                commissionRate:commRate, taxRate:taxR
              });
              const s = summarize(trades);
              if (s.closed < 3) continue;
              validCombos++;

              // ìŠ¤ì½”ì–´ë§: ìŠ¹ë¥  ê·¹ëŒ€í™” (80%+ ëª©í‘œ)
              // ìŠ¹ë¥  80%+ ê°•ë ¥ ë³´ë„ˆìŠ¤, 70%+ ì¼ë°˜, 60% ë¯¸ë§Œ íŒ¨ë„í‹°
              const winScore = s.winRate >= 80 ? s.winRate * 0.8
                             : s.winRate >= 70 ? s.winRate * 0.55
                             : s.winRate * 0.3;
              const cumScore = Math.max(0, Math.min(s.cumReturn / 200, 1)) * 15;
              const avgRetScore = Math.max(0, Math.min((s.avgReturn + 5) / 15, 1)) * 5;
              const tradeScore = Math.min(s.closed / 8, 1) * 10;
              // ìŠ¹ë¥  60% ë¯¸ë§Œ ê°•ë ¥ íŒ¨ë„í‹°
              const winPenalty = s.winRate < 50 ? -30 : (s.winRate < 60 ? -15 : 0);
              const score = winScore + cumScore + avgRetScore + tradeScore + winPenalty;

              const candidate = {
                score, tp, sl, cd, bw, bi, bmh,
                  winRate: s.winRate, trades: s.closed,
                  cumReturn: s.cumReturn, avgReturn: s.avgReturn,
                  wins: s.wins, losses: s.losses,
                };

              // ì•ˆì •í˜•: ìŠ¹ë¥  ê·¹ëŒ€í™” (ê¸°ì¡´ ë¡œì§ ê·¸ëŒ€ë¡œ)
              if (!best || score > best.score) {
                best = candidate;
              }

              // ìˆ˜ìµí˜•: í‰ê· ìˆ˜ìµë¥  ê·¹ëŒ€í™”
              const pScore = s.avgReturn * 5 + Math.min(Math.max(s.cumReturn, 0), 200) * 0.05 + Math.min(s.closed / 5, 1) * 3 + (s.winRate < 35 ? -30 : 0);
              if (!bestProfit || pScore > bestProfit._profitScore) {
                bestProfit = { ...candidate, _profitScore: pScore };
              }
            }
          }
        }
      }
    }
  }

  // â”€â”€ STEP2: í…ŒìŠ¤íŠ¸ êµ¬ê°„ì—ì„œ ìµœì  íŒŒë¼ë¯¸í„°ë¡œ ìˆœìˆ˜ í‰ê°€ â”€â”€
  if (best) {
    const testTrades = runBacktest(idata, {
      takeProfit: best.tp, stopLoss: best.sl, cooldown: best.cd,
      benfordWindow: best.bw, profileName, benfordInfluence: best.bi,
      startIdx: testStart,
      benfordMinHits: best.bmh,
      commissionRate:commRate, taxRate:taxR
    });
    const testSummary = summarize(testTrades);

    best.totalCombos = totalCombos;
    best.validCombos = validCombos;
    best.volLabel = volLabel;
    best.dailyVol = dailyVol;

    // í›ˆë ¨/í…ŒìŠ¤íŠ¸ ê¸°ê°„ ì •ë³´
    best.trainPeriod = `${idata[trainStartIdx].date} ~ ${idata[trainEnd-1].date} (${trainEnd - trainStartIdx}ì¼)`;
    best.testPeriod = `${idata[testStart].date} ~ ${idata[totalLen-1].date} (${totalLen - testStart}ì¼)`;
    best.trainLabel = 'í›ˆë ¨';
    best.testLabel = 'í…ŒìŠ¤íŠ¸(ë¯¸ë˜)';

    // í…ŒìŠ¤íŠ¸ êµ¬ê°„ ê²°ê³¼ (ê³¼ì í•© ì•„ë‹Œ ì‹¤ì „ ì„±ê³¼ ì¶”ì •)
    best.testWinRate = testSummary.winRate;
    best.testTrades = testSummary.closed;
    best.testCumReturn = testSummary.cumReturn;
    best.testAvgReturn = testSummary.avgReturn;
    best.testWins = testSummary.wins;
    best.testLosses = testSummary.losses;

    // í”„ë¡œí•„ ê¸°ë³¸ê°’ê³¼ ë¹„êµ
    const defaultProfile = STOCK_PROFILES[profileName];
    best.defaultTP = defaultProfile.takeProfit / 100;
    best.defaultSL = defaultProfile.stopLoss / 100;
    best.defaultCD = defaultProfile.cooldown;

    // ìˆ˜ìµí˜• ì „ëµ ì²¨ë¶€ + í…ŒìŠ¤íŠ¸ êµ¬ê°„ í‰ê°€
    if (bestProfit) {
      const profitTestTrades = runBacktest(idata, {
        takeProfit: bestProfit.tp, stopLoss: bestProfit.sl, cooldown: bestProfit.cd,
        benfordWindow: bestProfit.bw, profileName, benfordInfluence: bestProfit.bi,
        startIdx: testStart,
        benfordMinHits: bestProfit.bmh,
        commissionRate:commRate, taxRate:taxR
      });
      const profitTestSummary = summarize(profitTestTrades);
      bestProfit.testWinRate = profitTestSummary.winRate;
      bestProfit.testTrades = profitTestSummary.closed;
      bestProfit.testCumReturn = profitTestSummary.cumReturn;
      bestProfit.testAvgReturn = profitTestSummary.avgReturn;
      best.profitBest = bestProfit;
    }

    // í…ŒìŠ¤íŠ¸ = í‰ê°€ (120ì¼ë¡œ í†µì¼ë˜ì—ˆìœ¼ë¯€ë¡œ ë³„ë„ eval ë¶ˆí•„ìš”)
    best.evalWinRate = best.testWinRate;
    best.evalTrades = best.testTrades;
    best.evalAvgReturn = best.testAvgReturn;
    best.evalCumReturn = best.testCumReturn;
    best.evalPeriod = best.testPeriod;
    if (bestProfit) {
      bestProfit.evalWinRate = bestProfit.testWinRate;
      bestProfit.evalTrades = bestProfit.testTrades;
      bestProfit.evalAvgReturn = bestProfit.testAvgReturn;
      bestProfit.evalCumReturn = bestProfit.testCumReturn;
    }
  }
  return best;
}

function applyBestStrategy(profileName, optResult) {
  const pb = optResult.profitBest;
  let usePb = false;
  if (pb) {
    const stableRet = optResult.evalTrades > 0 ? optResult.evalAvgReturn :
                      optResult.testTrades > 0 ? optResult.testAvgReturn : optResult.avgReturn;
    const profitRet = pb.evalTrades > 0 ? pb.evalAvgReturn :
                      pb.testTrades > 0 ? pb.testAvgReturn : pb.avgReturn;
    const profitWR = pb.evalTrades > 0 ? pb.evalWinRate :
                     pb.testTrades > 0 ? pb.testWinRate : pb.winRate;
    if (profitRet > stableRet + 1 && profitWR >= 40) usePb = true;
  }
  const p = usePb ? pb : optResult;
  applyRecommendation(profileName, p.tp, p.sl, p.cd, p.bw, p.bi, p.bmh || 3);
}

function applyRecommendation(profileName, tp, sl, cd, bw, bi, bmh) {
  document.getElementById('stockProfile').value = profileName;
  document.getElementById('takeProfit').value = Math.round(tp * 100);
  document.getElementById('stopLoss').value = Math.round(sl * 100);
  document.getElementById('cooldown').value = cd;
  if (bw != null) document.getElementById('benfordWindow').value = bw;
  if (bi != null) document.getElementById('benfordInfluence').value = bi;
  if (bmh != null) document.getElementById('benfordMinHits').value = bmh;
}

function calcInvestmentScore(data, optResult) {
  const scores = { strategy: 0, signal: 0, profit: 0, trend: 0, confidence: 0 };

  // 1) ì „ëµ ìŠ¹ë¥  (30ì ) â€” 30% ì›Œí¬í¬ì›Œë“œ í‰ê°€ ìš°ì„ , ì—†ìœ¼ë©´ í›ˆë ¨
  const wr = (optResult.evalTrades > 0) ? optResult.evalWinRate :
             (optResult.testTrades > 0) ? optResult.testWinRate : optResult.winRate;
  scores.strategy = Math.round(Math.min(Math.max(wr / 100 * 30, 0), 30));

  // 2) í˜„ì¬ ë§¤ìˆ˜ ìŠ¤ì½”ì–´ (25ì ) â€” ë§ˆì§€ë§‰ ë‚ ì§œ
  if (data && data.length > 60) {
    const lastIdx = data.length - 1;
    const bds = precomputeBenfordDailyScores(data, optResult.bw || 30);
    const buyResult = calcBuyScore(data, lastIdx, null, optResult.bi || 15, optResult.bw || 30, optResult.bmh || 3, bds);
    const buyScore = typeof buyResult === 'object' ? buyResult.score : buyResult;
    scores.signal = Math.round(Math.min(Math.max(buyScore / 10 * 25, 0), 25));
  }

  // 3) ìˆ˜ìµì„± (20ì ) â€” 30% ì›Œí¬í¬ì›Œë“œ í‰ê· ìˆ˜ìµë¥  (-5%â†’0, 0%â†’10, +5%â†’20)
  const avgRet = (optResult.evalTrades > 0) ? optResult.evalAvgReturn :
                 (optResult.testTrades > 0) ? optResult.testAvgReturn : optResult.avgReturn;
  scores.profit = Math.round(Math.min(Math.max((avgRet + 5) / 10 * 20, 0), 20));

  // 4) ì¶”ì„¸ ê±´ì „ì„± (15ì ) â€” MAì •ë°°ì—´, RSI, MACD
  if (data && data.length > 60) {
    const last = data[data.length - 1];
    if (last.ma5 > last.ma20 && last.ma20 > last.ma60) scores.trend += 5;
    else if (last.ma5 > last.ma20) scores.trend += 2;
    if (last.rsi != null && last.rsi >= 30 && last.rsi <= 60) scores.trend += 5;
    else if (last.rsi != null && last.rsi > 60 && last.rsi <= 70) scores.trend += 3;
    if (last.macdHist != null && last.macdHist > 0) scores.trend += 5;
    else if (last.macdHist != null && last.macd > last.macdSignal) scores.trend += 2;
  }

  // 5) í†µê³„ ì‹ ë¢°ë„ (10ì ) â€” 30% ì›Œí¬í¬ì›Œë“œ ê±°ë˜ìˆ˜
  const evalN = optResult.evalTrades || optResult.testTrades || 0;
  scores.confidence = Math.round(Math.min(evalN / 5 * 10, 10));

  const total = scores.strategy + scores.signal + scores.profit + scores.trend + scores.confidence;
  let grade, gradeColor;
  if (total >= 80) { grade = 'ë§¤ìˆ˜ ì ê·¹ ì¶”ì²œ'; gradeColor = '#4caf50'; }
  else if (total >= 60) { grade = 'ë§¤ìˆ˜ ê²€í† '; gradeColor = '#f5c842'; }
  else if (total >= 40) { grade = 'ê´€ë§ ì¶”ì²œ'; gradeColor = '#ff9800'; }
  else { grade = 'íˆ¬ì ë¶€ì í•©'; gradeColor = '#ef5350'; }

  return { total, grade, gradeColor, scores };
}

function showRecommendBanner(detection, optResult) {
  document.getElementById('globalOptToast').classList.remove('active');
  const banner = document.getElementById('recommendBanner');
  const typeLabel = detection.isLargeCap ? 'ëŒ€í˜• ìš°ëŸ‰ì£¼' : 'ì¤‘ì†Œí˜• ì„±ì¥ì£¼';
  const vol = detection.volatility;

  const sName = stockData ? stockData.name : '';
  const sCode = stockData ? stockData.symbol : '';
  let html = `<div style="font-size:18px; font-weight:800; color:#f5c842; margin-bottom:6px;">${sName} <span style="font-size:13px; font-weight:500; color:#888;">(${sCode})</span> <span style="font-size:14px; font-weight:600; color:#ccc;">ì£¼ê°€ íŠ¹ì„± ìë™ ë¶„ì„ ì™„ë£Œ</span></div>`;
  html += `<div class="rec-detail">`;
  html += `ì¼í‰ê·  ë³€ë™í­: <span class="rec-highlight">${(vol.avgATR*100).toFixed(2)}%</span> `;
  html += `â†’ <span class="rec-highlight">${typeLabel}</span>ë¡œ íŒë³„`;

  if (optResult) {
    // ìµœì í™” ê³¼ì • ë¡œê·¸
    html += `<div style="margin-top:10px; padding:10px 12px; background:#12122a; border:1px solid #252540; border-radius:6px; font-size:12px; line-height:1.8;">`;
    html += `<div style="color:#5b9bd5; font-weight:600; margin-bottom:4px;">ìµœì í™” ë¶„ì„ ë¦¬í¬íŠ¸</div>`;

    // Step 1: ë³€ë™ì„± ë¶„ì„
    html += `<div style="color:#888;">STEP 1. ë³€ë™ì„± ë¶„ì„</div>`;
    html += `<div style="margin-left:12px;">`;
    html += `ì¼í‰ê·  ATR: <span style="color:#f5c842;">${optResult.dailyVol.toFixed(2)}%</span> â†’ `;
    html += `ë³€ë™ì„± ë“±ê¸‰: <span style="color:#f5c842;">${optResult.volLabel}</span>`;
    html += `</div>`;

    // Step 2: íƒìƒ‰ ë²”ìœ„
    html += `<div style="color:#888; margin-top:4px;">STEP 2. ìµœì  íŒŒë¼ë¯¸í„° íƒìƒ‰</div>`;
    html += `<div style="margin-left:12px;">`;
    const validPct = optResult.totalCombos > 0 ? Math.round(optResult.validCombos / optResult.totalCombos * 100) : 0;
    html += `ìµì ˆ/ì†ì ˆ/ì¿¨ë‹¤ìš´ ë“± <span style="color:#f5c842;">${optResult.totalCombos.toLocaleString()}ê°€ì§€</span> ì„¤ì •ì„ ì‹œë®¬ë ˆì´ì…˜í•˜ì—¬ ìµœì ê°’ì„ ì„ ì •`;
    if (validPct < 100) {
      html += ` (ìœ íš¨ ${validPct}%)`;
    }
    html += `</div>`;

    // Step 3: ê¸°ë³¸ê°’ vs ìµœì ê°’ ë¹„êµ
    html += `<div style="color:#888; margin-top:4px;">STEP 3. ê¸°ë³¸ê°’ â†’ ìµœì ê°’ ë³€ê²½ ë‚´ì—­</div>`;
    html += `<div style="margin-left:12px;">`;
    const changes = [];
    if (optResult.defaultTP !== optResult.tp)
      changes.push(`ìµì ˆ: ${(optResult.defaultTP*100).toFixed(0)}% â†’ <span style="color:#4caf50;">${(optResult.tp*100).toFixed(0)}%</span>`);
    else
      changes.push(`ìµì ˆ: ${(optResult.tp*100).toFixed(0)}% (ë³€ê²½ì—†ìŒ)`);
    if (optResult.defaultSL !== optResult.sl)
      changes.push(`ì†ì ˆ: ${(optResult.defaultSL*100).toFixed(0)}% â†’ <span style="color:#4caf50;">${(optResult.sl*100).toFixed(0)}%</span>`);
    else
      changes.push(`ì†ì ˆ: ${(optResult.sl*100).toFixed(0)}% (ë³€ê²½ì—†ìŒ)`);
    if (optResult.defaultCD !== optResult.cd)
      changes.push(`ì¿¨ë‹¤ìš´: ${optResult.defaultCD}ì¼ â†’ <span style="color:#4caf50;">${optResult.cd}ì¼</span>`);
    else
      changes.push(`ì¿¨ë‹¤ìš´: ${optResult.cd}ì¼ (ë³€ê²½ì—†ìŒ)`);
    changes.push(`ë²¤í¬ë“œìœˆë„ìš°: <span style="color:#4caf50;">${optResult.bw}ì¼</span>`);
    changes.push(`ë²¤í¬ë“œì˜í–¥ë„: <span style="color:#4caf50;">${optResult.bi}%</span>`);
    changes.push(`ì„¸ë ¥ìµœì†Œê°ì§€: <span style="color:#4caf50;">${optResult.bmh||3}íšŒ</span>`);
    html += changes.join(' / ');
    html += `</div>`;

    // Step 4: íˆ¬ì ë§¤ë ¥ë„ í‰ê°€ + í…ŒìŠ¤íŠ¸ êµ¬ê°„
    const hasTest = optResult.testTrades != null;
    const evalPeriodLabel = optResult.testPeriod || '';
    html += `<div style="color:#888; margin-top:4px;">STEP 4. íˆ¬ì ë§¤ë ¥ë„ í‰ê°€ <span style="font-size:10px; color:#555;" title="ìµœê·¼ 6ê°œì›”(120ê±°ë˜ì¼) ì„±ê³¼ë¥¼ ê¸°ë°˜ìœ¼ë¡œ í˜„ ì‹œì  íˆ¬ì ë§¤ë ¥ë„ë¥¼ í‰ê°€í•©ë‹ˆë‹¤.">(${evalPeriodLabel})</span></div>`;
    html += `<div style="margin-left:12px;">`;

    // íˆ¬ì ë§¤ë ¥ë„ ì ìˆ˜ ê³„ì‚° (ì§€í‘œ ê³„ì‚°ëœ ë°ì´í„° í•„ìš”)
    let scoreData = null;
    if (stockData && stockData.data && stockData.data.length > 60) {
      scoreData = calcIndicators(JSON.parse(JSON.stringify(stockData.data)));
    }
    const invScore = calcInvestmentScore(scoreData, optResult);
    const barItems = [
      { label: 'ì „ëµ ìŠ¹ë¥ ', score: invScore.scores.strategy, max: 30,
        tipTitle: 'ì „ëµ ìŠ¹ë¥ ì´ë€?',
        tipBody: 'ê³¼ê±° ë°ì´í„°ì˜ ë’¤ 30%ë¥¼ <strong>ë¯¸ë˜ë¼ê³  ê°€ì •</strong>í•˜ê³ , ìµœì í™”ëœ ì „ëµì´ ì‹¤ì œë¡œ ì–¼ë§ˆë‚˜ ë§ì·„ëŠ”ì§€ ì¸¡ì •í•œ ìŠ¹ë¥ ì…ë‹ˆë‹¤.',
        tipExample: 'ìŠ¹ë¥  100% â†’ 30ì , 50% â†’ 15ì , 0% â†’ 0ì ',
        tipRecommend: 'ë†’ì„ìˆ˜ë¡ ì „ëµì´ ë‹¤ì–‘í•œ ì‹œì¥ ìƒí™©ì—ì„œ ì˜ ì‘ë™í•¨ì„ ì˜ë¯¸' },
      { label: 'ë§¤ìˆ˜ ìŠ¤ì½”ì–´', score: invScore.scores.signal, max: 25,
        tipTitle: 'ë§¤ìˆ˜ ìŠ¤ì½”ì–´ë€?',
        tipBody: '<strong>ì˜¤ëŠ˜(ë§ˆì§€ë§‰ ê±°ë˜ì¼)</strong> ê¸°ì¤€ìœ¼ë¡œ ë§¤ìˆ˜ ì‹œê·¸ë„ì´ ì–¼ë§ˆë‚˜ ê°•í•œì§€ ì¸¡ì •í•©ë‹ˆë‹¤.<br><br>â€¢ íŒ¨í„´A: ê³¼ë§¤ë„ í›„ ë°˜ë“± ê°ì§€<br>â€¢ íŒ¨í„´B: ìƒìŠ¹ ì¶”ì„¸ ì¶”ì¢…<br>â€¢ ë²¤í¬ë“œ: ì„¸ë ¥ ë§¤ì§‘ í”ì  ê°ì§€',
        tipExample: 'ìŠ¤ì½”ì–´ 10+ â†’ 25ì , 5 â†’ 12ì , 0 â†’ 0ì ',
        tipRecommend: '0ì ì´ë©´ ì§€ê¸ˆì€ ë§¤ìˆ˜ íƒ€ì´ë°ì´ ì•„ë‹˜' },
      { label: 'ìˆ˜ìµì„±', score: invScore.scores.profit, max: 20,
        tipTitle: 'ìˆ˜ìµì„±ì´ë€?',
        tipBody: 'í…ŒìŠ¤íŠ¸ êµ¬ê°„ì—ì„œ <strong>ê±°ë˜ë‹¹ í‰ê·  ìˆ˜ìµë¥ </strong>ì…ë‹ˆë‹¤. í•œ ë²ˆ ì‚¬ê³  íŒ” ë•Œ í‰ê· ì ìœ¼ë¡œ ì–¼ë§ˆë¥¼ ë²Œì—ˆëŠ”ì§€ë¥¼ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤.',
        tipExample: '+5% â†’ 20ì , 0% â†’ 10ì , -5% â†’ 0ì ',
        tipRecommend: '10ì  ì´ìƒì´ë©´ ìˆ˜ìµ ê¸°ëŒ€ì¹˜ê°€ ì–‘ìˆ˜' },
      { label: 'ì¶”ì„¸ ê±´ì „ì„±', score: invScore.scores.trend, max: 15,
        tipTitle: 'ì¶”ì„¸ ê±´ì „ì„±ì´ë€?',
        tipBody: 'í˜„ì¬ ì£¼ê°€ì˜ <strong>ê¸°ìˆ ì  ì§€í‘œ ìƒíƒœ</strong>ë¥¼ 3ê°€ì§€ë¡œ í‰ê°€í•©ë‹ˆë‹¤ (ê° 5ì ):<br><br>â€¢ <strong>MA ì •ë°°ì—´</strong>: ë‹¨ê¸°>ì¤‘ê¸°>ì¥ê¸° ì´ë™í‰ê·  = ìƒìŠ¹ ì¶”ì„¸<br>â€¢ <strong>RSI ì ì •ëŒ€</strong>: 30~60 ì‚¬ì´ = ê³¼ë§¤ìˆ˜/ê³¼ë§¤ë„ ì•„ë‹Œ ì•ˆì •ê¶Œ<br>â€¢ <strong>MACD ì–‘ì „í™˜</strong>: íˆìŠ¤í† ê·¸ë¨ ì–‘ìˆ˜ = ìƒìŠ¹ ëª¨ë©˜í…€',
        tipExample: '3ê°œ ëª¨ë‘ ì¶©ì¡± â†’ 15ì , 0ê°œ â†’ 0ì ',
        tipRecommend: '0ì ì´ë©´ í˜„ì¬ í•˜ë½ ì¶”ì„¸ì´ê±°ë‚˜ ê³¼ì—´ ìƒíƒœ' },
      { label: 'í†µê³„ ì‹ ë¢°ë„', score: invScore.scores.confidence, max: 10,
        tipTitle: 'í†µê³„ ì‹ ë¢°ë„ë€?',
        tipBody: 'í…ŒìŠ¤íŠ¸ êµ¬ê°„ì—ì„œ ë°œìƒí•œ <strong>ê±°ë˜ ê±´ìˆ˜</strong>ì…ë‹ˆë‹¤. ê±°ë˜ê°€ ë§ì„ìˆ˜ë¡ ìŠ¹ë¥ ê³¼ ìˆ˜ìµì„± ìˆ˜ì¹˜ë¥¼ ë” ì‹ ë¢°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.',
        tipExample: '5ê±´+ â†’ 10ì , 3ê±´ â†’ 6ì , 1ê±´ â†’ 2ì ',
        tipRecommend: '2ê±´ ì´í•˜ë©´ í†µê³„ì  ì˜ë¯¸ê°€ ì•½í•¨ â€” ì°¸ê³  ìˆ˜ì¤€' },
    ];

    // ì ìˆ˜ ë°•ìŠ¤
    html += `<div style="display:flex; align-items:center; gap:20px; background:#16162a; border:1px solid ${invScore.gradeColor}44; border-radius:10px; padding:16px 20px; margin:8px 0;">`;
    // ì™¼ìª½: í° ì ìˆ˜
    html += `<div style="text-align:center; min-width:90px;">`;
    html += `<div style="font-size:40px; font-weight:800; color:${invScore.gradeColor}; line-height:1;">${invScore.total}</div>`;
    html += `<div style="font-size:11px; color:#888; margin-top:2px;">/ 100ì </div>`;
    html += `<div style="font-size:13px; font-weight:700; color:${invScore.gradeColor}; margin-top:4px;">${invScore.grade}</div>`;
    html += `</div>`;
    // ì˜¤ë¥¸ìª½: í•­ëª©ë³„ ë°”
    html += `<div style="flex:1;">`;
    for (const item of barItems) {
      const pct = item.max > 0 ? Math.round(item.score / item.max * 100) : 0;
      const barColor = pct >= 70 ? '#4caf50' : (pct >= 40 ? '#f5c842' : '#ef5350');
      html += `<div style="display:flex; align-items:center; gap:8px; margin:3px 0; font-size:11px;">`;
      html += `<div style="width:85px; color:#999; text-align:right; white-space:nowrap;">`;
      html += `${item.label} `;
      html += `<span class="tooltip-wrap"><span class="tooltip-icon" style="width:13px;height:13px;font-size:8px;">?</span>`;
      html += `<span class="tooltip-content">`;
      html += `<div class="tip-title">${item.tipTitle}</div>`;
      html += `${item.tipBody}`;
      html += `<div class="tip-example">${item.tipExample}</div>`;
      html += `<div class="tip-recommend">${item.tipRecommend}</div>`;
      html += `</span></span></div>`;
      html += `<div style="flex:1; background:#1a1a2e; border-radius:3px; height:10px; overflow:hidden;">`;
      html += `<div style="width:${pct}%; height:100%; background:${barColor}; border-radius:3px; transition:width 0.3s;"></div>`;
      html += `</div>`;
      html += `<div style="width:40px; color:#aaa; font-size:10px;">${item.score}/${item.max}</div>`;
      html += `</div>`;
    }
    html += `</div>`;
    html += `</div>`;

    // í‰ê°€ ê¸°ê°„ ìš”ì•½ (ì ìˆ˜ ë°•ìŠ¤ ì•„ë˜)
    if (hasTest && optResult.testTrades > 0) {
      const avgRetColor = optResult.testAvgReturn >= 0 ? '#4caf50' : '#ef5350';
      html += `<div style="font-size:11px; color:#888; margin-top:4px;">`;
      html += `í‰ê°€êµ¬ê°„ ${optResult.testPeriod||''}: `;
      html += `<span style="color:${optResult.testWinRate>=50?'#4caf50':'#ef5350'};">ìŠ¹ë¥  ${optResult.testWinRate.toFixed(0)}%</span>`;
      html += ` Â· ${optResult.testTrades}ê±´ ê±°ë˜`;
      html += ` Â· <span style="color:${avgRetColor};">í‰ê· ìˆ˜ìµë¥  ${optResult.testAvgReturn>=0?'+':''}${optResult.testAvgReturn.toFixed(2)}%</span>`;
      html += `</div>`;
    } else if (hasTest && optResult.testTrades === 0) {
      html += `<div style="color:#f5c842; margin-top:4px; font-size:11px;">âš  í‰ê°€ ê¸°ê°„ì— ë§¤ìˆ˜ ì‹œê·¸ë„ ì—†ìŒ</div>`;
    }
    html += `</div>`;

    // Step 5: ì¶”ì²œ ì „ëµ ì„ íƒ (ìë™ ì¶”ì²œ + ìœ ì € ë³€ê²½ ê°€ëŠ¥)
    const pb = optResult.profitBest;
    // ì¶”ì²œ íŒë‹¨: 30% ì›Œí¬í¬ì›Œë“œ í‰ê°€ ê¸°ì¤€ ë¹„êµ
    let recommend = 'stable';
    let recommendReason = '';
    // ë¹„êµìš© ì§€í‘œ (eval ìš°ì„  â†’ test â†’ train fallback)
    const stableWR = optResult.evalTrades > 0 ? optResult.evalWinRate :
                     optResult.testTrades > 0 ? optResult.testWinRate : optResult.winRate;
    const stableRet = optResult.evalTrades > 0 ? optResult.evalAvgReturn :
                      optResult.testTrades > 0 ? optResult.testAvgReturn : optResult.avgReturn;
    const stableN = optResult.evalTrades || optResult.testTrades || 0;
    let profitWR = 0, profitRet = 0, profitN = 0;
    if (pb) {
      profitWR = pb.evalTrades > 0 ? pb.evalWinRate :
                 pb.testTrades > 0 ? pb.testWinRate : pb.winRate;
      profitRet = pb.evalTrades > 0 ? pb.evalAvgReturn :
                  pb.testTrades > 0 ? pb.testAvgReturn : pb.avgReturn;
      profitN = pb.evalTrades || pb.testTrades || 0;
      if (profitRet > stableRet + 1 && profitWR >= 40) {
        recommend = 'profit';
        recommendReason = `ìˆ˜ìµí˜•ì´ ìˆ˜ìµë¥ ì—ì„œ ìœ ë¦¬ (${profitRet>=0?'+':''}${profitRet.toFixed(1)}% vs ${stableRet>=0?'+':''}${stableRet.toFixed(1)}%)`;
      } else if (stableWR >= profitWR + 10) {
        recommendReason = `ì•ˆì •í˜•ì´ ìŠ¹ë¥ ì—ì„œ ìœ ë¦¬ (${stableWR.toFixed(0)}% vs ${profitWR.toFixed(0)}%)`;
      } else if (stableWR >= 70) {
        recommendReason = `ì•ˆì •í˜• ìŠ¹ë¥  ${stableWR.toFixed(0)}%ë¡œ ì•ˆì •ì  ë§¤ë§¤ ê°€ëŠ¥`;
      } else {
        recommendReason = `ì•ˆì •í˜•ì´ ìŠ¹ë¥ -ìˆ˜ìµ ê· í˜•ì—ì„œ ìœ ë¦¬`;
      }
    }

    html += `<div style="color:#888; margin-top:4px;">STEP 5. ì¶”ì²œ ì „ëµ ì„ íƒ</div>`;
    html += `<div style="margin-left:12px;">`;
    // ë¹„êµ í…Œì´ë¸”
    if (pb) {
      html += `<div style="font-size:10px; color:#555; margin:4px 0 2px;">ë°±í…ŒìŠ¤íŠ¸ ì‹¤ì  ë¹„êµ (${evalPeriodLabel})</div>`;
      html += `<table style="font-size:11px; border-collapse:collapse; width:100%; margin:0 0 8px;">`;
      html += `<tr style="color:#666;">`;
      html += `<th style="padding:3px 6px; border-bottom:1px solid #333; text-align:left;">ì „ëµ</th>`;
      html += `<th style="padding:3px 6px; border-bottom:1px solid #333;">ìŠ¹ë¥ </th>`;
      html += `<th style="padding:3px 6px; border-bottom:1px solid #333;">ê±°ë˜</th>`;
      html += `<th style="padding:3px 6px; border-bottom:1px solid #333;">í‰ê· ìˆ˜ìµë¥ </th>`;
      html += `<th style="padding:3px 6px; border-bottom:1px solid #333;">íŒì •</th>`;
      html += `</tr>`;
      const sColor = recommend === 'stable' ? '#5b9bd5' : '#888';
      const pColor = recommend === 'profit' ? '#e040fb' : '#888';
      html += `<tr style="color:${sColor};">`;
      html += `<td style="padding:3px 6px;">ì•ˆì •í˜•</td>`;
      html += `<td style="padding:3px 6px; text-align:center;">${stableWR.toFixed(0)}%</td>`;
      html += `<td style="padding:3px 6px; text-align:center;">${stableN}ê±´</td>`;
      html += `<td style="padding:3px 6px; text-align:center;">${stableRet>=0?'+':''}${stableRet.toFixed(2)}%</td>`;
      html += `<td style="padding:3px 6px; text-align:center;">${recommend==='stable'?'âœ“ ì¶”ì²œ':''}</td>`;
      html += `</tr>`;
      html += `<tr style="color:${pColor};">`;
      html += `<td style="padding:3px 6px;">ìˆ˜ìµí˜•</td>`;
      html += `<td style="padding:3px 6px; text-align:center;">${profitWR.toFixed(0)}%</td>`;
      html += `<td style="padding:3px 6px; text-align:center;">${profitN}ê±´</td>`;
      html += `<td style="padding:3px 6px; text-align:center;">${profitRet>=0?'+':''}${profitRet.toFixed(2)}%</td>`;
      html += `<td style="padding:3px 6px; text-align:center;">${recommend==='profit'?'âœ“ ì¶”ì²œ':''}</td>`;
      html += `</tr>`;
      html += `</table>`;
      if (recommendReason) {
        html += `<div style="font-size:11px; color:#aaa; margin:0 0 8px;">â†’ ${recommendReason}</div>`;
      }
    } else if (recommendReason) {
      html += `<div style="font-size:11px; color:#aaa; margin:4px 0 8px;">${recommendReason}</div>`;
    }
    html += `<div style="display:flex; gap:10px;">`;
    // ì•ˆì •í˜• ë²„íŠ¼
    const stableActive = recommend === 'stable';
    const stableBorder = stableActive ? '#5b9bd5' : '#3a3a5e';
    const stableColor = stableActive ? '#f5c842' : '#aaa';
    html += `<button class="btn btn-sm strategy-pick" style="flex:1; padding:10px 12px; background:#1a2a3e; border:2px solid ${stableBorder}; border-radius:8px; color:${stableColor}; font-weight:700; font-size:13px; cursor:pointer; position:relative;" onclick="applyRecommendation('${detection.profileName}',${optResult.tp},${optResult.sl},${optResult.cd},${optResult.bw},${optResult.bi},${optResult.bmh||3}); document.querySelectorAll('.strategy-pick').forEach(b=>{b.style.borderColor='#3a3a5e';b.style.color='#aaa';b.querySelector('.rec-badge')&&(b.querySelector('.rec-badge').style.background='#3a3a5e');}); this.style.borderColor='#5b9bd5'; this.style.color='#f5c842';">`;
    html += `ì•ˆì •í˜•(ìŠ¹ë¥ )`;
    if (stableActive) html += `<span class="rec-badge" style="position:absolute;top:-8px;right:-8px;background:#5b9bd5;color:#fff;font-size:9px;padding:2px 6px;border-radius:8px;font-weight:600;">ì¶”ì²œ</span>`;
    html += `</button>`;
    // ìˆ˜ìµí˜• ë²„íŠ¼
    if (pb) {
      const profitActive = recommend === 'profit';
      const profitBorder = profitActive ? '#e040fb' : '#3a3a5e';
      const profitColor = profitActive ? '#e040fb' : '#aaa';
      html += `<button class="btn btn-sm strategy-pick" style="flex:1; padding:10px 12px; background:#1a2a3e; border:2px solid ${profitBorder}; border-radius:8px; color:${profitColor}; font-weight:700; font-size:13px; cursor:pointer; position:relative;" onclick="applyRecommendation('${detection.profileName}',${pb.tp},${pb.sl},${pb.cd},${pb.bw},${pb.bi},${pb.bmh||3}); document.querySelectorAll('.strategy-pick').forEach(b=>{b.style.borderColor='#3a3a5e';b.style.color='#aaa';b.querySelector('.rec-badge')&&(b.querySelector('.rec-badge').style.background='#3a3a5e');}); this.style.borderColor='#e040fb'; this.style.color='#e040fb';">`;
      html += `ìˆ˜ìµí˜•(ìˆ˜ìµë¥ )`;
      if (profitActive) html += `<span class="rec-badge" style="position:absolute;top:-8px;right:-8px;background:#e040fb;color:#fff;font-size:9px;padding:2px 6px;border-radius:8px;font-weight:600;">ì¶”ì²œ</span>`;
      html += `</button>`;
    }
    html += `</div>`;
    html += `</div>`;

    html += `</div>`; // ë¡œê·¸ ë°•ìŠ¤ ë‹«ê¸°
  }
  html += `</div>`;
  html += `<div class="rec-actions">`;
  if (!optResult) {
    const defBw = 30, defBi = 15;
    html += `<button class="btn btn-sm btn-outline active" onclick="applyRecommendation('${detection.profileName}',${detection.isLargeCap?0.10:0.17},${detection.isLargeCap?0.10:0.07},${detection.isLargeCap?5:3},${defBw},${defBi},3)">ì¶”ì²œê°’ ì ìš©</button>`;
  }
  html += `</div>`;

  banner.innerHTML = html;
  banner.classList.add('active');
}

// ============================================================
// 9. ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
// ============================================================
let stockData = null;

const uploadArea = document.getElementById('uploadArea');
const fileInput = document.getElementById('fileInput');
const analyzeBtn = document.getElementById('analyzeBtn');

// ì¢…ëª©ëª… â†’ ì½”ë“œ ë§¤í•‘ (ì£¼ìš” ì¢…ëª©)
const STOCK_MAP = {
  'ì‚¼ì„±ì „ì':'005930','ì‚¼ì„±ì „ììš°':'005935','SKí•˜ì´ë‹‰ìŠ¤':'000660','LGì—ë„ˆì§€ì†”ë£¨ì…˜':'373220',
  'ì‚¼ì„±ë°”ì´ì˜¤ë¡œì§ìŠ¤':'207940','í˜„ëŒ€ì°¨':'005380','ê¸°ì•„':'000270','ì…€íŠ¸ë¦¬ì˜¨':'068270',
  'KBê¸ˆìœµ':'105560','ì‹ í•œì§€ì£¼':'055550','POSCOí™€ë”©ìŠ¤':'005490','ë„¤ì´ë²„':'035420',
  'ì¹´ì¹´ì˜¤':'035720','ì‚¼ì„±SDI':'006400','LGí™”í•™':'051910','í˜„ëŒ€ëª¨ë¹„ìŠ¤':'012330',
  'ì¹´ì¹´ì˜¤í˜ì´':'377300','ì¹´ì¹´ì˜¤ë±…í¬':'323410','í¬ë˜í”„í†¤':'259960','ì—”ì”¨ì†Œí”„íŠ¸':'036570',
  'SKì´ë…¸ë² ì´ì…˜':'096770','í•œí™”ì—ì–´ë¡œìŠ¤í˜ì´ìŠ¤':'012450','ë‘ì‚°ì—ë„ˆë¹Œë¦¬í‹°':'034020',
  'LGì „ì':'066570','ì‚¼ì„±ë¬¼ì‚°':'028260','SKí…”ë ˆì½¤':'017670','KT':'030200',
  'LG':'003550','í•œêµ­ì „ë ¥':'015760','ì‚¼ì„±í™”ì¬':'000810','í•˜ë‚˜ê¸ˆìœµì§€ì£¼':'086790',
  'ìš°ë¦¬ê¸ˆìœµì§€ì£¼':'316140','SK':'034730','í˜„ëŒ€ê±´ì„¤':'000720','ëŒ€í•œí•­ê³µ':'003490',
  'í•œí™”ì˜¤ì…˜':'042660','HDí˜„ëŒ€ì¤‘ê³µì—…':'329180','HDí•œêµ­ì¡°ì„ í•´ì–‘':'009540',
  'HLB':'028300','ì—ì½”í”„ë¡œë¹„ì— ':'247540','ì—ì½”í”„ë¡œ':'086520','í¬ìŠ¤ì½”í“¨ì²˜ì— ':'003670',
  'ë‘ì‚°ë°¥ìº£':'241560','í•œë¯¸ë°˜ë„ì²´':'042700','ë¦¬ë…¸ê³µì—…':'058470','ì•Œí…Œì˜¤ì  ':'196170',
  'SKë°”ì´ì˜¤íŒœ':'326030','í„ì–´ë¹„ìŠ¤':'263750','ìœ„ë©”ì´ë“œ':'112040','ì»´íˆ¬ìŠ¤':'078340',
  'ì‚¼ì„±ì—”ì§€ë‹ˆì–´ë§':'028050','GSê±´ì„¤':'006360','í˜„ëŒ€ì œì² ':'004020',
};

// ì¢…ëª©ì½”ë“œ/ì¢…ëª©ëª… â†’ XML ìë™ ë‹¤ìš´ë¡œë“œ ì‹œë„
document.getElementById('fetchBtn').addEventListener('click', generateXmlLink);
document.getElementById('symbolInput').addEventListener('keydown', e=>{if(e.key==='Enter')generateXmlLink();});

function generateXmlLink() {
  const input = document.getElementById('symbolInput').value.trim();
  const resultDiv = document.getElementById('xmlLinkResult');
  if (!input) { resultDiv.style.display='none'; return; }

  let code = null;
  let name = null;

  if (/^\d{6}$/.test(input)) {
    code = input;
    name = Object.entries(STOCK_MAP).find(([_,v])=>v===input)?.[0] || code;
  } else {
    const query = input.toLowerCase();
    const matches = Object.entries(STOCK_MAP).filter(([k])=>k.toLowerCase().includes(query));
    if (matches.length === 1) {
      [name, code] = matches[0];
    } else if (matches.length > 1) {
      let html = `<div style="color:#f5c842; margin-bottom:8px;">"${input}" ê²€ìƒ‰ ê²°ê³¼ (${matches.length}ê±´) â€” í´ë¦­í•˜ì—¬ ì„ íƒ:</div>`;
      html += `<div style="display:flex; flex-wrap:wrap; gap:6px;">`;
      matches.forEach(([n,c]) => {
        html += `<span style="background:#252540; padding:4px 10px; border-radius:4px; cursor:pointer; border:1px solid #3a3a5e;" onclick="document.getElementById('symbolInput').value='${c}';generateXmlLink();">${n} (${c})</span>`;
      });
      html += `</div>`;
      resultDiv.innerHTML = html;
      resultDiv.style.display = 'block';
      return;
    } else {
      resultDiv.innerHTML = `<span style="color:#ef5350;">ì¢…ëª©ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. 6ìë¦¬ ì¢…ëª©ì½”ë“œë¥¼ ì§ì ‘ ì…ë ¥í•´ ì£¼ì„¸ìš”.</span>`;
      resultDiv.style.display = 'block';
      return;
    }
  }

  const url = `https://fchart.stock.naver.com/sise.nhn?symbol=${code}&timeframe=day&count=5000&requestType=0`;
  resultDiv.innerHTML = `<div style="color:#f5c842;">â³ <strong>${name}</strong> (${code}) ë°ì´í„° ìë™ ë‹¤ìš´ë¡œë“œ ì¤‘...</div>`;
  resultDiv.style.display = 'block';

  // ìë™ fetch ì‹œë„
  fetchStockXml(url, code, name, resultDiv);
}

async function fetchStockXml(url, code, name, resultDiv) {
  try {
    const resp = await fetch(url);
    if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
    const buf = await resp.arrayBuffer();
    // euc-kr ë””ì½”ë”© ì‹œë„
    let text;
    try { text = new TextDecoder('euc-kr').decode(buf); } catch(e) { text = new TextDecoder('utf-8').decode(buf); }

    // XML íŒŒì‹± ê²€ì¦
    stockData = parseXML(text);
    if (!stockData || !stockData.data || stockData.data.length === 0) throw new Error('ë°ì´í„° ì—†ìŒ');

    document.getElementById('fileName').textContent =
      `ğŸ“„ ${name} (${code}) â€” ${stockData.data.length}ì¼ ìë™ ë¡œë“œ ì™„ë£Œ`;
    analyzeBtn.disabled = false;

    resultDiv.innerHTML = `<div style="color:#4caf50;"><strong>${name}</strong> (${code}) â€” ${stockData.data.length}ì¼ ë°ì´í„° ìë™ ë¡œë“œ ì™„ë£Œ!</div>`;

    // ë³€ë™ì„± ë¶„ì„ â†’ í”„ë¡œí•„ íŒë³„
    const detection = autoDetectProfile(stockData.data);
    if (currentMode === 'auto') {
      document.getElementById('recommendBanner').innerHTML =
        `<div class="rec-title rec-title-loading">ìë™ ìµœì í™” ì§„í–‰ ì¤‘...</div><div class="rec-detail" style="color:#888;">6ê°œ íŒŒë¼ë¯¸í„° ì¡°í•© íƒìƒ‰ ì¤‘ì…ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.</div>`;
      document.getElementById('recommendBanner').classList.add('active');
      document.getElementById('globalOptToast').classList.add('active');
      setTimeout(() => {
        try {
          const si = getAnalysisStartIdx(stockData.data.length);
          const optResult = autoOptimize(stockData.data, detection.profileName, si);
          if (optResult) {
            applyBestStrategy(detection.profileName, optResult);
          }
          showRecommendBanner(detection, optResult);
        } catch(err) {
          console.error('ìë™ ìµœì í™” ì˜¤ë¥˜:', err);
          showRecommendBanner(detection, null);
        }
      }, 30);
    } else {
      const profile = STOCK_PROFILES[detection.profileName];
      applyRecommendation(detection.profileName, profile.takeProfit/100, profile.stopLoss/100, profile.cooldown, 30, 15, 3);
      showRecommendBanner(detection, null);
    }
  } catch(err) {
    // CORS ë˜ëŠ” ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ â†’ ë§í¬ ì•ˆë‚´ í´ë°±
    const fallbackHtml = `<div style="margin-bottom:6px;"><strong style="color:#5b9bd5;">${name}</strong> <span style="color:#888;">(${code})</span></div>`;
    let html = fallbackHtml;
    html += `<div style="color:#f5c842; font-size:12px; margin-bottom:6px;">ìë™ ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨ (CORS ì œí•œ). ì•„ë˜ ë°©ë²•ìœ¼ë¡œ ì§„í–‰í•´ ì£¼ì„¸ìš”:</div>`;
    html += `<div style="display:flex; align-items:center; gap:8px; flex-wrap:wrap;">`;
    html += `<button class="btn btn-sm btn-outline" onclick="window.open('${url}','_blank')" style="flex-shrink:0;">ìƒˆ íƒ­ì—ì„œ XML ì—´ê¸°</button>`;
    html += `<button class="btn btn-sm btn-outline" onclick="navigator.clipboard.writeText('${url}');this.textContent='ë³µì‚¬ë¨!';setTimeout(()=>this.textContent='ë§í¬ ë³µì‚¬',1500);" style="flex-shrink:0;">ë§í¬ ë³µì‚¬</button>`;
    html += `</div>`;
    html += `<div style="color:#666; font-size:12px; margin-top:6px;">ìƒˆ íƒ­ì—ì„œ ì—´ë¦° XML í˜ì´ì§€ë¥¼ Ctrl+S(Cmd+S)ë¡œ ì €ì¥ í›„ ìœ„ì— ì—…ë¡œë“œí•˜ì„¸ìš”.</div>`;
    resultDiv.innerHTML = html;
  }
}

uploadArea.addEventListener('click', ()=>fileInput.click());
uploadArea.addEventListener('dragover', e=>{e.preventDefault();uploadArea.classList.add('dragover');});
uploadArea.addEventListener('dragleave', ()=>uploadArea.classList.remove('dragover'));
uploadArea.addEventListener('drop', e=>{
  e.preventDefault(); uploadArea.classList.remove('dragover');
  if(e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]);
});
fileInput.addEventListener('change', e=>{
  if(e.target.files.length) handleFile(e.target.files[0]);
  fileInput.value = ''; // ê°™ì€ íŒŒì¼ ì¬ì—…ë¡œë“œ í—ˆìš©
});

function handleFile(file) {
  document.getElementById('fileName').textContent = 'ğŸ“„ '+file.name;
  const reader = new FileReader();
  reader.onload = e => {
    try {
      const decoder = new TextDecoder('euc-kr');
      const buf = e.target.result;
      let text = decoder.decode(buf);
      try { stockData = parseXML(text); }
      catch(err) {
        text = new TextDecoder('utf-8').decode(buf);
        stockData = parseXML(text);
      }
      document.getElementById('fileName').textContent =
        `ğŸ“„ ${file.name} â€” ${stockData.name} (${stockData.symbol}) ${stockData.data.length}ì¼ ë¡œë“œ ì™„ë£Œ`;
      analyzeBtn.disabled = false;

      // ë³€ë™ì„± ë¶„ì„ â†’ í”„ë¡œí•„ íŒë³„
      const detection = autoDetectProfile(stockData.data);

      if (currentMode === 'auto') {
        // ìë™ëª¨ë“œ: ì¦‰ì‹œ 6ê°œ íŒŒë¼ë¯¸í„° ìµœì í™” ì‹¤í–‰
        document.getElementById('recommendBanner').innerHTML =
          `<div class="rec-title rec-title-loading">ìë™ ìµœì í™” ì§„í–‰ ì¤‘...</div><div class="rec-detail" style="color:#888;">6ê°œ íŒŒë¼ë¯¸í„° ì¡°í•© íƒìƒ‰ ì¤‘ì…ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.</div>`;
        document.getElementById('recommendBanner').classList.add('active');
        document.getElementById('globalOptToast').classList.add('active');
        setTimeout(() => {
          try {
            const si = getAnalysisStartIdx(stockData.data.length);
            const optResult = autoOptimize(stockData.data, detection.profileName, si);
            if (optResult) {
              applyBestStrategy(detection.profileName, optResult);
            }
            showRecommendBanner(detection, optResult);
          } catch(err) {
            console.error('ìë™ ìµœì í™” ì˜¤ë¥˜:', err);
            showRecommendBanner(detection, null);
          }
        }, 30);
      } else {
        // ìˆ˜ë™ëª¨ë“œ: í”„ë¡œí•„ ê¸°ë³¸ê°’ ì ìš©
        const profile = STOCK_PROFILES[detection.profileName];
        applyRecommendation(detection.profileName, profile.takeProfit/100, profile.stopLoss/100, profile.cooldown, 30, 15, 3);
        showRecommendBanner(detection, null);
      }

    } catch(err) {
      document.getElementById('fileName').textContent = 'âŒ íŒŒì¼ íŒŒì‹± ì˜¤ë¥˜: '+err.message;
      analyzeBtn.disabled = true;
    }
  };
  reader.readAsArrayBuffer(file);
}

// ì¢…ëª© ìœ í˜• ë³€ê²½ ì‹œ íŒŒë¼ë¯¸í„° ìë™ ë³€ê²½
document.getElementById('stockProfile').addEventListener('change', function() {
  const profile = STOCK_PROFILES[this.value];
  if (profile) {
    document.getElementById('takeProfit').value = profile.takeProfit;
    document.getElementById('stopLoss').value = profile.stopLoss;
    document.getElementById('cooldown').value = profile.cooldown;
  }
});

// ì°¨íŠ¸ ì»¨íŠ¸ë¡¤ ë²„íŠ¼
document.getElementById('btnShowAll').addEventListener('click', showAllMarkers);
document.getElementById('btnClearChart').addEventListener('click', clearMarkers);

// ë¶„ì„ ì‹¤í–‰ (ê³µí†µ)
function executeAnalysis(tp, sl, cd, profileName) {
  const bw = parseInt(document.getElementById('benfordWindow').value);
  const bi = parseInt(document.getElementById('benfordInfluence').value) || 15;
  const bmh = parseInt(document.getElementById('benfordMinHits').value) || 3;
  const rangeVal = parseInt(document.getElementById('analysisRange').value) || 0;
  const commRate = parseFloat(document.getElementById('commissionRate').value) || 0;
  const taxR = parseFloat(document.getElementById('taxRate').value) || 0;
  const qty = parseInt(document.getElementById('quantity').value) || 10;

  const data = calcIndicators(JSON.parse(JSON.stringify(stockData.data)));

  // ë¶„ì„ ê¸°ê°„ ê³„ì‚°: 0ì´ë©´ ì „ì²´, Nì´ë©´ ë§ˆì§€ë§‰ Nê±°ë˜ì¼ë¶€í„°
  let startIdx = 60; // ê¸°ë³¸ (ê¸°ìˆ ì§€í‘œ ê³„ì‚°ì— ìµœì†Œ 60ì¼ í•„ìš”)
  let rangeLabel = 'ì „ì²´ ê¸°ê°„';
  if (rangeVal > 0 && rangeVal < data.length) {
    startIdx = Math.max(60, data.length - rangeVal);
    rangeLabel = `ìµœê·¼ ${rangeVal}ê±°ë˜ì¼ (${data[startIdx].date} ~ ${data[data.length-1].date})`;
  }

  const trades = runBacktest(data, {takeProfit:tp,stopLoss:sl,cooldown:cd,benfordWindow:bw,profileName,benfordInfluence:bi,startIdx,benfordMinHits:bmh,commissionRate:commRate,taxRate:taxR,quantity:qty});
  const summary = summarize(trades);
  summary.rangeLabel = rangeLabel;

  renderStats(summary, {...stockData, data});
  renderChart(data, trades);
  renderTrades(trades);
}

// ë¶„ì„ ì‹œì‘
analyzeBtn.addEventListener('click', ()=>{
  if(!stockData) return;
  const loading = document.getElementById('loading');
  const results = document.getElementById('results');
  loading.classList.add('active');
  results.classList.add('hidden');

  setTimeout(()=>{
    try {
      // í•­ìƒ í˜„ì¬ UIì— í‘œì‹œëœ íŒŒë¼ë¯¸í„°ê°’ìœ¼ë¡œ ë¶„ì„ ì‹¤í–‰
      // (ìë™ ìµœì í™”ëŠ” ë°ì´í„° ë¡œë“œ ì‹œ ë˜ëŠ” ëª¨ë“œ ì „í™˜ ì‹œì—ë§Œ ì‹¤í–‰ë¨)
      document.getElementById('loadingMsg').textContent = 'ë¶„ì„ ì¤‘... ê¸°ìˆ ì§€í‘œ ê³„ì‚° ë° ë°±í…ŒìŠ¤íŠ¸ ì‹¤í–‰';
      const tp = parseFloat(document.getElementById('takeProfit').value)/100;
      const sl = parseFloat(document.getElementById('stopLoss').value)/100;
      const cd = parseInt(document.getElementById('cooldown').value);
      const profileName = document.getElementById('stockProfile').value;
      executeAnalysis(tp, sl, cd, profileName);

      loading.classList.remove('active');
      results.classList.remove('hidden');

      // ì°¨íŠ¸ê°€ hidden ìƒíƒœì—ì„œ ìƒì„±ë˜ì–´ width=0 ë¬¸ì œ í•´ê²°
      requestAnimationFrame(()=>{
        if(mainChart){
          const cc=document.getElementById('chartContainer');
          mainChart.applyOptions({width:cc.clientWidth});
          mainChart.timeScale().fitContent();
        }
        if(volChart){
          const vc=document.getElementById('volumeContainer');
          volChart.applyOptions({width:vc.clientWidth});
        }
      });

      results.scrollIntoView({behavior:'smooth'});
    } catch(err) {
      loading.classList.remove('active');
      alert('ë¶„ì„ ì˜¤ë¥˜: '+err.message+'\n'+err.stack);
    }
  }, 50);
});
</script>
</body>
</html>
